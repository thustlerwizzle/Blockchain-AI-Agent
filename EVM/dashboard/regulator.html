<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regulatory Monitoring Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #0f4c75 0%, #3282b8 50%, #bbe1fa 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-left: 6px solid #0f4c75;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header .subtitle {
            opacity: 0.9;
            font-size: 14px;
        }

        .alert-banner {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .alert-banner.critical {
            background: #fee2e2;
            border-left-color: #ef4444;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            color: #0f4c75;
            margin-bottom: 20px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .metric-large {
            font-size: 48px;
            font-weight: bold;
            color: #0f4c75;
            margin: 10px 0;
        }

        .metric-label {
            color: #6b7280;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-top: 10px;
        }

        .status-healthy {
            background: #d1fae5;
            color: #065f46;
        }

        .status-moderate {
            background: #fef3c7;
            color: #92400e;
        }

        .status-at-risk {
            background: #fed7aa;
            color: #9a3412;
        }

        .status-critical {
            background: #fee2e2;
            color: #991b1b;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e5e7eb;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3282b8, #bbe1fa);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .progress-fill.high-risk {
            background: linear-gradient(90deg, #ef4444, #f87171);
        }

        .progress-fill.medium-risk {
            background: linear-gradient(90deg, #f59e0b, #fbbf24);
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: #6b7280;
            font-size: 14px;
        }

        .stat-value {
            font-weight: bold;
            color: #111827;
        }

        .violation-item {
            padding: 12px;
            margin-bottom: 10px;
            background: #fef2f2;
            border-left: 4px solid #ef4444;
            border-radius: 5px;
        }

        .violation-item.medium {
            background: #fffbeb;
            border-left-color: #f59e0b;
        }

        .violation-item.low {
            background: #f0fdf4;
            border-left-color: #10b981;
        }

        .recommendation-item {
            padding: 15px;
            margin-bottom: 10px;
            background: #e0f2fe;
            border-left: 4px solid #3282b8;
            border-radius: 5px;
        }

        .pattern-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: #f9fafb;
            margin-bottom: 8px;
            border-radius: 5px;
        }

        .risk-distribution {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .risk-segment {
            flex: 1;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .risk-segment.high {
            background: #fee2e2;
            color: #991b1b;
        }

        .risk-segment.medium {
            background: #fef3c7;
            color: #92400e;
        }

        .risk-segment.low {
            background: #d1fae5;
            color: #065f46;
        }

        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #3282b8;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }

        .refresh-btn:hover {
            background: #0f4c75;
            transform: translateY(-2px);
        }

        .last-updated {
            text-align: center;
            color: #6b7280;
            font-size: 12px;
            margin-top: 20px;
        }

        /* Enhanced Professional Styles */
        body {
            background: linear-gradient(135deg, #e8f4f8 0%, #d1e7dd 50%, #f0f9ff 100%);
            background-attachment: fixed;
            min-height: 100vh;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid rgba(59, 130, 246, 0.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        .header {
            background: linear-gradient(135deg, #0f4c75 0%, #3282b8 50%, #bbe1fa 100%);
            box-shadow: 0 10px 40px rgba(15, 76, 117, 0.3);
        }

        /* High-Risk Transaction Flow Styles */
        .flow-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        .flow-item {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border-left: 5px solid #ef4444;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.2);
            transition: all 0.3s ease;
        }

        .flow-item:hover {
            transform: translateX(5px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.3);
        }

        .flow-path {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
        }

        .flow-arrow {
            font-size: 24px;
            color: #ef4444;
        }

        .chain-badge {
            display: inline-block;
            padding: 6px 12px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            margin: 0 5px;
        }

        .address-link {
            color: #3b82f6;
            text-decoration: none;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .address-link:hover {
            text-decoration: underline;
        }

        .recommendation-card {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border-left: 5px solid #3b82f6;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2);
        }

        .chain-analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .chain-analysis-card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #0ea5e9;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.2);
        }

        .metric-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
        }

        .metric-value {
            font-size: 42px;
            font-weight: 700;
            background: linear-gradient(135deg, #0f4c75, #3282b8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 10px 0;
        }

        .section-title {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #0f4c75, #3282b8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Tab Styles */
        .tab-button {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: #6b7280;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-button:hover {
            color: #3282b8;
            background: rgba(50, 130, 184, 0.05);
        }

        .tab-button.active {
            color: #0f4c75;
            border-bottom-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 15px;">
                <div style="flex: 1;">
                    <h1 style="margin: 0; font-size: 32px; font-weight: 700;">Regulatory Monitoring Dashboard</h1>
                    <div class="subtitle" style="font-size: 16px; margin-top: 5px; opacity: 0.95;">Real-time Multi-Chain Transaction Monitoring & Compliance</div>
                </div>
            </div>
            <div class="subtitle" style="font-size: 14px; margin-top: 10px;">
                Digital Asset Business Act 2018 (DABA) ‚Ä¢ Real-time Multi-Chain Monitoring ‚Ä¢ Risk-Based Regulatory Framework
            </div>
        </div>


        <div id="alertBanner" class="alert-banner" style="display: none;">
            <strong>‚ö†Ô∏è Alert:</strong> <span id="alertMessage"></span>
        </div>

        <!-- REGULATORY SUMMARY - Suspicious Addresses Overview -->
        <div class="card" style="margin-bottom: 20px; border: 3px solid #dc2626; background: linear-gradient(135deg, #fee2e2 0%, #fef2f2 100%);">
            <h2 class="section-title" style="color: #dc2626; margin-bottom: 20px;">
                üö® REGULATORY SUMMARY - SUSPICIOUS ADDRESSES
            </h2>
            <div id="regulatorySummary" style="background: white; border-radius: 12px; padding: 25px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px;">
                    <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #fee2e2, #fecaca); border-radius: 10px;">
                        <div style="font-size: 36px; font-weight: bold; color: #dc2626;" id="summaryOverallRiskLevel">LOADING...</div>
                        <div style="font-size: 14px; color: #991b1b; margin-top: 5px; font-weight: bold;">Overall Risk Level</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #fee2e2, #fecaca); border-radius: 10px;">
                        <div style="font-size: 36px; font-weight: bold; color: #dc2626;" id="summaryCriticalCount">0</div>
                        <div style="font-size: 14px; color: #991b1b; margin-top: 5px; font-weight: bold;">Critical Addresses (‚â•80)</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #fef3c7, #fde68a); border-radius: 10px;">
                        <div style="font-size: 36px; font-weight: bold; color: #d97706;" id="summaryHighRiskCount">0</div>
                        <div style="font-size: 14px; color: #92400e; margin-top: 5px; font-weight: bold;">High-Risk Addresses (70-79)</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #fee2e2, #fecaca); border-radius: 10px;">
                        <div style="font-size: 36px; font-weight: bold; color: #dc2626;" id="summaryTotalSuspicious">0</div>
                        <div style="font-size: 14px; color: #991b1b; margin-top: 5px; font-weight: bold;">Total Suspicious Addresses</div>
                    </div>
                </div>

                <!-- Critical Addresses Section -->
                <div id="criticalAddressesSection" style="margin-bottom: 25px;">
                    <h3 style="color: #dc2626; font-size: 20px; margin-bottom: 15px; font-weight: bold;">
                        üî¥ CRITICAL ADDRESSES REQUIRING IMMEDIATE ATTENTION
                    </h3>
                    <div id="criticalAddressesList" style="max-height: 400px; overflow-y: auto;">
                        <p style="color: #6b7280; text-align: center; padding: 20px;">Loading critical addresses...</p>
                    </div>
                </div>

                <!-- Risk Categories Breakdown with Address Lists -->
                <div style="margin-bottom: 25px;">
                    <h3 style="color: #d97706; font-size: 18px; margin-bottom: 15px; font-weight: bold;">
                        üìä RISK CATEGORIES BREAKDOWN - ADDRESS LISTS
                    </h3>
                    
                    <!-- Rapid Transactions -->
                    <div style="margin-bottom: 20px; border: 2px solid #f59e0b; border-radius: 10px; overflow: hidden;">
                        <div onclick="toggleCategory('rapidTx')" style="padding: 15px; background: #fef3c7; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <span style="font-size: 24px; font-weight: bold; color: #d97706;" id="catRapidTx">0</span>
                                <div>
                                    <div style="font-weight: bold; color: #92400e; font-size: 14px;">Rapid Transactions</div>
                                    <div style="font-size: 11px; color: #92400e; margin-top: 2px;">Click to view addresses</div>
                                </div>
                            </div>
                            <span id="rapidTxToggle" style="font-size: 20px;">‚ñº</span>
                        </div>
                        <div id="rapidTxList" style="display: none; max-height: 400px; overflow-y: auto; background: white; padding: 15px;">
                            <p style="color: #6b7280; text-align: center; padding: 20px;">Loading addresses...</p>
                        </div>
                    </div>

                    <!-- Large Value Transactions -->
                    <div style="margin-bottom: 20px; border: 2px solid #f59e0b; border-radius: 10px; overflow: hidden;">
                        <div onclick="toggleCategory('largeValue')" style="padding: 15px; background: #fef3c7; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <span style="font-size: 24px; font-weight: bold; color: #d97706;" id="catLargeValue">0</span>
                                <div>
                                    <div style="font-weight: bold; color: #92400e; font-size: 14px;">Large Value Transactions</div>
                                    <div style="font-size: 11px; color: #92400e; margin-top: 2px;">Click to view addresses</div>
                                </div>
                            </div>
                            <span id="largeValueToggle" style="font-size: 20px;">‚ñº</span>
                        </div>
                        <div id="largeValueList" style="display: none; max-height: 400px; overflow-y: auto; background: white; padding: 15px;">
                            <p style="color: #6b7280; text-align: center; padding: 20px;">Loading addresses...</p>
                        </div>
                    </div>

                    <!-- Structuring -->
                    <div style="margin-bottom: 20px; border: 2px solid #f59e0b; border-radius: 10px; overflow: hidden;">
                        <div onclick="toggleCategory('structuring')" style="padding: 15px; background: #fef3c7; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <span style="font-size: 24px; font-weight: bold; color: #d97706;" id="catStructuring">0</span>
                                <div>
                                    <div style="font-weight: bold; color: #92400e; font-size: 14px;">Potential Structuring</div>
                                    <div style="font-size: 11px; color: #92400e; margin-top: 2px;">Click to view addresses</div>
                                </div>
                            </div>
                            <span id="structuringToggle" style="font-size: 20px;">‚ñº</span>
                        </div>
                        <div id="structuringList" style="display: none; max-height: 400px; overflow-y: auto; background: white; padding: 15px;">
                            <p style="color: #6b7280; text-align: center; padding: 20px;">Loading addresses...</p>
                        </div>
                    </div>

                    <!-- Multi-Chain Activity -->
                    <div style="margin-bottom: 20px; border: 2px solid #f59e0b; border-radius: 10px; overflow: hidden;">
                        <div onclick="toggleCategory('multiChain')" style="padding: 15px; background: #fef3c7; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <span style="font-size: 24px; font-weight: bold; color: #d97706;" id="catMultiChain">0</span>
                                <div>
                                    <div style="font-weight: bold; color: #92400e; font-size: 14px;">Multi-Chain Activity</div>
                                    <div style="font-size: 11px; color: #92400e; margin-top: 2px;">Click to view addresses</div>
                                </div>
                            </div>
                            <span id="multiChainToggle" style="font-size: 20px;">‚ñº</span>
                        </div>
                        <div id="multiChainList" style="display: none; max-height: 400px; overflow-y: auto; background: white; padding: 15px;">
                            <p style="color: #6b7280; text-align: center; padding: 20px;">Loading addresses...</p>
                        </div>
                    </div>

                    <!-- High Connections -->
                    <div style="margin-bottom: 20px; border: 2px solid #f59e0b; border-radius: 10px; overflow: hidden;">
                        <div onclick="toggleCategory('highConn')" style="padding: 15px; background: #fef3c7; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <span style="font-size: 24px; font-weight: bold; color: #d97706;" id="catHighConn">0</span>
                                <div>
                                    <div style="font-weight: bold; color: #92400e; font-size: 14px;">High Connections</div>
                                    <div style="font-size: 11px; color: #92400e; margin-top: 2px;">Click to view addresses</div>
                                </div>
                            </div>
                            <span id="highConnToggle" style="font-size: 20px;">‚ñº</span>
                        </div>
                        <div id="highConnList" style="display: none; max-height: 400px; overflow-y: auto; background: white; padding: 15px;">
                            <p style="color: #6b7280; text-align: center; padding: 20px;">Loading addresses...</p>
                        </div>
                    </div>
                </div>

                <!-- Regulatory Recommendations -->
                <div>
                    <h3 style="color: #1e40af; font-size: 18px; margin-bottom: 15px; font-weight: bold;">
                        üí° REGULATORY RECOMMENDATIONS
                    </h3>
                    <div id="regulatoryRecommendations" style="background: #eff6ff; border-left: 4px solid #3b82f6; padding: 20px; border-radius: 8px;">
                        <p style="color: #6b7280; text-align: center;">Loading recommendations...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- DABA Compliance Overview -->
        <div class="grid">
            <div class="card" style="grid-column: span 2;">
                <h2>üìú DABA Compliance Status</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div>
                        <div class="metric-large" id="dabaOverall" style="font-size: 36px;">0</div>
                        <div class="metric-label">Overall DABA Compliance</div>
                    </div>
                    <div>
                        <div class="stat-row">
                            <span class="stat-label">License Class</span>
                            <span class="stat-value" id="dabaLicense">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">License Status</span>
                            <span class="stat-value" id="dabaStatus">-</span>
                        </div>
                    </div>
                    <div>
                        <div class="stat-row">
                            <span class="stat-label">Client Asset Custody</span>
                            <span class="stat-value" id="dabaCustody">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Cyber Risk Management</span>
                            <span class="stat-value" id="dabaCyber">-</span>
                        </div>
                    </div>
                    <div>
                        <div class="stat-row">
                            <span class="stat-label">AML/ATF Compliance</span>
                            <span class="stat-value" id="dabaAML">-</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Regulatory Reporting</span>
                            <span class="stat-value" id="dabaReporting">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Multi-Chain Data -->
        <div class="card" style="margin-bottom: 20px;">
            <h2>üåê Multi-Chain Blockchain Monitoring</h2>
            <div id="multiChainData" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">
                <div style="text-align: center; padding: 20px; grid-column: 1/-1; background: #f9fafb; border-radius: 8px;">
                    <p style="color: #6b7280; margin-bottom: 10px;">No chain data available yet</p>
                    <p style="font-size: 12px; color: #9ca3af;">Chain data will appear as transactions are processed</p>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e5e7eb;">
            <button class="tab-button active" onclick="switchTab('crypto-market')" id="tab-crypto-market">
                üíπ Live Crypto Market
            </button>
            <button class="tab-button" onclick="switchTab('blockchain-monitor')" id="tab-blockchain-monitor">
                üîç Blockchain Monitor
            </button>
            <button class="tab-button" onclick="switchTab('financial-statements')" id="tab-financial-statements">
                üìä DABA Financial Statements
            </button>
        </div>

        <!-- Live Crypto Market Tab -->
        <div id="tab-content-crypto-market" class="tab-content active">
            <div class="card" style="margin-bottom: 20px;">
                <h2>üíπ Live Crypto Market Analysis</h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                    <div class="metric-card">
                        <div class="metric-label">ETH Price (USD)</div>
                        <div class="metric-value" id="ethPrice" style="font-size: 32px;">$0.00</div>
                        <div style="font-size: 12px; color: #10b981; margin-top: 5px;" id="ethPriceChange">Loading...</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Current Block</div>
                        <div class="metric-value" id="currentBlock" style="font-size: 32px;">0</div>
                        <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">Ethereum Mainnet</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Gas Price - Safe</div>
                        <div class="metric-value" id="gasSafe" style="font-size: 24px;">0</div>
                        <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">Gwei</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Gas Price - Proposed</div>
                        <div class="metric-value" id="gasProposed" style="font-size: 24px;">0</div>
                        <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">Gwei</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Gas Price - Fast</div>
                        <div class="metric-value" id="gasFast" style="font-size: 24px;">0</div>
                        <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">Gwei</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-label">Base Fee</div>
                        <div class="metric-value" id="gasBaseFee" style="font-size: 24px;">0</div>
                        <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">Gwei</div>
                    </div>
                </div>
                <div style="margin-top: 20px; text-align: center; color: #6b7280; font-size: 12px;">
                    Last updated: <span id="marketLastUpdated">Never</span>
                </div>
            </div>
        </div>

        <!-- Financial Statements Tab -->
        <div id="tab-content-financial-statements" class="tab-content" style="display: none;">
            <div class="card" style="margin-bottom: 20px; border: 2px solid #1e40af;">
                <h2 class="section-title" style="color: #1e40af;">üìä Financial Statement Analysis</h2>
                <div style="background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                        <select id="entitySelect" style="flex: 1; min-width: 200px; padding: 12px; border: 2px solid #3b82f6; border-radius: 6px; font-size: 14px;">
                            <option value="">Select DABA Entity...</option>
                        </select>
                        <button onclick="loadEntityFinancials()" style="padding: 12px 24px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                            üìä Load Financials
                        </button>
                        <button onclick="generateMockFinancials()" style="padding: 12px 24px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                            üß™ Generate Mock Analysis
                        </button>
                    </div>
                    <div style="margin-bottom: 15px; padding: 15px; background: #f0f9ff; border: 2px dashed #3b82f6; border-radius: 6px;">
                        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                            <label for="fileUpload" style="padding: 12px 24px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; display: inline-block;">
                                üìÑ Upload Financial Statement
                            </label>
                            <input type="file" id="fileUpload" accept=".txt,.pdf,.doc,.docx" style="display: none;" onchange="handleFileUpload(event)">
                            <span id="fileName" style="color: #6b7280; font-size: 14px;"></span>
                            <button onclick="analyzeUploadedFile()" id="analyzeBtn" style="padding: 12px 24px; background: #8b5cf6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; display: none;">
                                üîç Analyze Uploaded File
                            </button>
                        </div>
                        <div style="font-size: 11px; color: #6b7280; margin-top: 8px;">
                            Supported formats: .txt, .pdf, .doc, .docx (PDF will be parsed, text files will be analyzed directly)
                        </div>
                    </div>
                    <div style="font-size: 12px; color: #6b7280; background: #eff6ff; padding: 12px; border-radius: 6px; border-left: 4px solid #3b82f6;">
                        <strong>‚ÑπÔ∏è Note:</strong> Financial statements are analyzed using rule-based analysis from similar entity data. 
                        No API keys required. Upload your financial statement file for automated compliance analysis.
                    </div>
                </div>

                <!-- Entity Info -->
                <div id="entityInfo" style="display: none; background: #eff6ff; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #1e40af; margin-bottom: 15px;">Entity Information</h3>
                    <div id="entityDetails" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <!-- Entity details will be populated here -->
                    </div>
                </div>

                <!-- Financial Statements List -->
                <div id="financialStatementsSection">
                    <h3 style="color: #1e40af; margin-bottom: 15px;">Financial Statements & AI Analysis</h3>
                    <div id="financialStatementsList" style="max-height: 600px; overflow-y: auto;">
                        <div style="text-align: center; padding: 40px; background: #f9fafb; border-radius: 8px;">
                            <p style="color: #6b7280; margin-bottom: 10px;">No financial statements loaded</p>
                            <p style="font-size: 12px; color: #9ca3af;">Select an entity and load or generate financial statements for AI analysis</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- DeFi Trends Research Section -->
            <div class="card" style="margin-bottom: 20px; border: 2px solid #9333ea; background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 class="section-title" style="color: #9333ea; margin: 0;">üöÄ DeFi Trends & Market Research</h2>
                    <button onclick="loadDeFiTrends()" style="padding: 10px 20px; background: #9333ea; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px;">
                        üîÑ Refresh Research
                    </button>
                </div>
                <div style="font-size: 12px; color: #6b7280; background: #f3e8ff; padding: 12px; border-radius: 6px; border-left: 4px solid #9333ea; margin-bottom: 15px;">
                    <strong>‚ÑπÔ∏è Comprehensive Research & Horizon Scanning:</strong> In-depth analysis of DeFi trends, market developments, emerging technologies, and future opportunities. 
                    Includes real-time market insights and horizon scanning for strategic planning.
                </div>
                
                <div id="defiTrendsContent" style="background: white; border-radius: 8px; padding: 20px;">
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <div style="font-size: 48px; margin-bottom: 15px;">üìä</div>
                        <p style="margin-bottom: 10px; font-weight: bold;">DeFi Trends Research</p>
                        <p style="font-size: 12px; color: #9ca3af;">Click "Refresh Research" to load the latest DeFi market trends and analysis</p>
                    </div>
                </div>
            </div>

            <!-- Latest Crypto News Section -->
            <div class="card" style="margin-bottom: 20px; border: 2px solid #10b981; background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 class="section-title" style="color: #10b981; margin: 0;">üì∞ Latest Crypto News</h2>
                    <button onclick="loadCryptoNews()" style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 13px;">
                        üîÑ Refresh News
                    </button>
                </div>
                <div style="font-size: 12px; color: #6b7280; background: #d1fae5; padding: 12px; border-radius: 6px; border-left: 4px solid #10b981; margin-bottom: 15px;">
                    <strong>‚ÑπÔ∏è Real-Time News Feed:</strong> Stay updated with the latest cryptocurrency and blockchain news from trusted sources. 
                    News updates automatically every 5 minutes.
                </div>
                
                <div id="cryptoNewsContent" style="background: white; border-radius: 8px; padding: 20px;">
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <div style="font-size: 48px; margin-bottom: 15px;">üì∞</div>
                        <p style="margin-bottom: 10px; font-weight: bold;">Crypto News Feed</p>
                        <p style="font-size: 12px; color: #9ca3af;">Click "Refresh News" to load the latest cryptocurrency news</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Blockchain Monitor Tab - Bitcoin Data Analysis Style -->
        <div id="tab-content-blockchain-monitor" class="tab-content" style="display: none;">
            <style>
                /* Dark theme for blockchain monitor - completely different from other tabs */
                #tab-content-blockchain-monitor {
                    background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
                    padding: 20px;
                    border-radius: 12px;
                    min-height: 100vh;
                }
                
                .blockchain-card {
                    background: rgba(15, 23, 42, 0.8);
                    border: 1px solid rgba(148, 163, 184, 0.2);
                    border-radius: 12px;
                    padding: 24px;
                    margin-bottom: 20px;
                    backdrop-filter: blur(10px);
                    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                }
                
                .blockchain-card h2 {
                    color: #60a5fa;
                    font-size: 22px;
                    margin-bottom: 20px;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    text-transform: uppercase;
                    letter-spacing: 1px;
                    font-weight: 600;
                }
                
                .network-stats-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 15px;
                    margin-bottom: 20px;
                }
                
                .stat-box {
                    background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(147, 51, 234, 0.1) 100%);
                    border: 1px solid rgba(96, 165, 250, 0.3);
                    border-radius: 8px;
                    padding: 20px;
                    text-align: center;
                    transition: transform 0.2s, box-shadow 0.2s;
                }
                
                .stat-box:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 4px 20px rgba(96, 165, 250, 0.3);
                }
                
                .stat-box-label {
                    color: #94a3b8;
                    font-size: 12px;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                    margin-bottom: 8px;
                }
                
                .stat-box-value {
                    color: #60a5fa;
                    font-size: 32px;
                    font-weight: bold;
                    font-family: 'Courier New', monospace;
                }
                
                .stat-box-change {
                    color: #10b981;
                    font-size: 11px;
                    margin-top: 5px;
                }
                
                .blockchain-table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-top: 15px;
                }
                
                .blockchain-table th {
                    background: rgba(59, 130, 246, 0.2);
                    color: #60a5fa;
                    padding: 12px;
                    text-align: left;
                    font-size: 12px;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                    border-bottom: 2px solid rgba(96, 165, 250, 0.3);
                }
                
                .blockchain-table td {
                    color: #cbd5e1;
                    padding: 12px;
                    border-bottom: 1px solid rgba(148, 163, 184, 0.1);
                    font-family: 'Courier New', monospace;
                    font-size: 13px;
                }
                
                .blockchain-table tr:hover {
                    background: rgba(96, 165, 250, 0.05);
                }
                
                .chain-selector {
                    display: flex;
                    gap: 10px;
                    margin-bottom: 20px;
                    flex-wrap: wrap;
                }
                
                .chain-btn {
                    padding: 10px 20px;
                    background: rgba(59, 130, 246, 0.2);
                    border: 1px solid rgba(96, 165, 250, 0.3);
                    border-radius: 6px;
                    color: #60a5fa;
                    cursor: pointer;
                    font-weight: 500;
                    transition: all 0.2s;
                }
                
                .chain-btn:hover {
                    background: rgba(59, 130, 246, 0.3);
                    border-color: #60a5fa;
                }
                
                .chain-btn.active {
                    background: linear-gradient(135deg, #3b82f6 0%, #9333ea 100%);
                    border-color: #60a5fa;
                    color: white;
                }
                
                .block-visualization {
                    display: grid;
                    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                    gap: 10px;
                    margin-top: 15px;
                }
                
                .block-item {
                    background: linear-gradient(135deg, rgba(59, 130, 246, 0.15) 0%, rgba(147, 51, 234, 0.15) 100%);
                    border: 1px solid rgba(96, 165, 250, 0.3);
                    border-radius: 6px;
                    padding: 12px;
                    text-align: center;
                    transition: all 0.2s;
                }
                
                .block-item:hover {
                    transform: scale(1.05);
                    box-shadow: 0 4px 15px rgba(96, 165, 250, 0.4);
                }
                
                .block-number {
                    color: #60a5fa;
                    font-size: 14px;
                    font-weight: bold;
                    font-family: 'Courier New', monospace;
                }
                
                .block-tx-count {
                    color: #10b981;
                    font-size: 11px;
                    margin-top: 5px;
                }
                
                .network-health {
                    display: flex;
                    align-items: center;
                    gap: 15px;
                    padding: 15px;
                    background: rgba(16, 185, 129, 0.1);
                    border: 1px solid rgba(16, 185, 129, 0.3);
                    border-radius: 8px;
                    margin-top: 15px;
                }
                
                .health-indicator {
                    width: 12px;
                    height: 12px;
                    border-radius: 50%;
                    background: #10b981;
                    animation: pulse 2s infinite;
                }
                
                @keyframes pulse {
                    0%, 100% { opacity: 1; }
                    50% { opacity: 0.5; }
                }
                
                .chart-container {
                    background: rgba(15, 23, 42, 0.6);
                    border: 1px solid rgba(148, 163, 184, 0.2);
                    border-radius: 8px;
                    padding: 15px;
                    margin-top: 15px;
                    height: 300px;
                    position: relative;
                }
                
                .metric-badge {
                    display: inline-block;
                    padding: 4px 10px;
                    border-radius: 12px;
                    font-size: 11px;
                    font-weight: bold;
                    margin-left: 8px;
                }
                
                .badge-success { background: rgba(16, 185, 129, 0.2); color: #10b981; }
                .badge-warning { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
                .badge-danger { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
            </style>
            
            <!-- Network Overview -->
            <div class="blockchain-card">
                <h2>üåê Multi-Chain Network Overview</h2>
                <div class="chain-selector">
                    <button class="chain-btn active" onclick="selectChain('ethereum')">Ethereum</button>
                    <button class="chain-btn" onclick="selectChain('polygon')">Polygon</button>
                    <button class="chain-btn" onclick="selectChain('bsc')">BSC</button>
                    <button class="chain-btn" onclick="selectChain('arbitrum')">Arbitrum</button>
                    <button class="chain-btn" onclick="selectChain('optimism')">Optimism</button>
                    <button class="chain-btn" onclick="selectChain('base')">Base</button>
                    <button class="chain-btn" onclick="selectChain('avalanche-fuji')">Avalanche</button>
                </div>
                
                <div class="network-stats-grid" id="networkStatsGrid">
                    <div class="stat-box">
                        <div class="stat-box-label">Current Block</div>
                        <div class="stat-box-value" id="currentBlockNumber">0</div>
                        <div class="stat-box-change" id="blockChange">Loading...</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box-label">Network Hashrate</div>
                        <div class="stat-box-value" id="networkHashrate">-</div>
                        <div class="stat-box-change">Estimated</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box-label">Transactions/Block</div>
                        <div class="stat-box-value" id="txPerBlock">0</div>
                        <div class="stat-box-change" id="txPerBlockChange">Avg: 0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box-label">Block Time</div>
                        <div class="stat-box-value" id="blockTime">0s</div>
                        <div class="stat-box-change">Average</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box-label">Gas Price</div>
                        <div class="stat-box-value" id="gasPrice">0</div>
                        <div class="stat-box-change" id="gasPriceChange">Gwei</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box-label">Network Status</div>
                        <div class="stat-box-value" style="font-size: 24px;" id="networkStatus">üü¢</div>
                        <div class="stat-box-change">Operational</div>
                    </div>
                </div>
                
                <div class="network-health">
                    <div class="health-indicator"></div>
                    <div style="color: #cbd5e1;">
                        <strong style="color: #10b981;">Network Healthy</strong>
                        <span style="color: #94a3b8; font-size: 12px; margin-left: 10px;" id="networkHealthDetails">All chains operational</span>
                    </div>
                </div>
            </div>
            
            <!-- Recent Blocks Explorer -->
            <div class="blockchain-card">
                <h2>üì¶ Recent Blocks Explorer</h2>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div style="color: #94a3b8; font-size: 13px;">Last 20 blocks</div>
                    <button onclick="refreshBlocks()" style="padding: 8px 16px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 6px; color: #60a5fa; cursor: pointer; font-size: 12px;">
                        üîÑ Refresh
                    </button>
                </div>
                <div class="block-visualization" id="blocksVisualization">
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #94a3b8;">
                        Loading blocks...
                    </div>
                </div>
            </div>
            
            <!-- Transaction Analysis -->
            <div class="blockchain-card">
                <h2>üìä Transaction Analysis</h2>
                <div class="network-stats-grid">
                    <div class="stat-box">
                        <div class="stat-box-label">Total Transactions (24h)</div>
                        <div class="stat-box-value" id="totalTx24h">0</div>
                        <div class="stat-box-change" id="totalTx24hChange">+0%</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box-label">Avg TX Size</div>
                        <div class="stat-box-value" id="avgTxSize">0</div>
                        <div class="stat-box-change">ETH</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box-label">TX Volume (24h)</div>
                        <div class="stat-box-value" id="txVolume24h">0</div>
                        <div class="stat-box-change">ETH</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box-label">Pending TX</div>
                        <div class="stat-box-value" id="pendingTx">0</div>
                        <div class="stat-box-change">In mempool</div>
                    </div>
                </div>
                
                <div class="chart-container" id="txChartContainer">
                    <canvas id="txChart" style="max-height: 280px;"></canvas>
                </div>
            </div>
            
            <!-- Network Activity by Chain -->
            <div class="blockchain-card">
                <h2>üîó Multi-Chain Activity Comparison</h2>
                <table class="blockchain-table">
                    <thead>
                        <tr>
                            <th>Chain</th>
                            <th>Block Height</th>
                            <th>TX Count</th>
                            <th>Gas Price</th>
                            <th>Status</th>
                            <th>Activity</th>
                        </tr>
                    </thead>
                    <tbody id="multiChainTableBody">
                        <tr>
                            <td colspan="6" style="text-align: center; color: #94a3b8; padding: 30px;">
                                Loading chain data...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Real-time Transaction Feed -->
            <div class="blockchain-card">
                <h2>‚ö° Real-Time Transaction Feed</h2>
                <div style="max-height: 500px; overflow-y: auto;" id="realtimeTxFeed">
                    <div style="text-align: center; padding: 30px; color: #94a3b8;">
                        Waiting for transactions...
                    </div>
                </div>
            </div>
            
            <!-- On-Chain Investigation Tools Section -->
            <div class="blockchain-card" style="border: 2px solid rgba(239, 68, 68, 0.5); background: rgba(239, 68, 68, 0.05);">
                <h2 style="color: #ef4444;">üîç On-Chain Investigation Tools</h2>
                <div style="color: #cbd5e1; font-size: 13px; margin-bottom: 20px; padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: 6px; border-left: 3px solid #ef4444;">
                    <strong>‚ö†Ô∏è Investigation Mode:</strong> Professional on-chain analysis tools for tracing transactions, analyzing flows, and investigating suspicious activities. Based on industry-standard investigation methodologies.
                </div>
                
                <!-- Address Investigation -->
                <div style="margin-bottom: 25px;">
                    <h3 style="color: #60a5fa; font-size: 18px; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                        üéØ Address Investigation
                    </h3>
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; margin-bottom: 15px;">
                        <input type="text" id="investigationAddressInput" placeholder="Enter address (0x...) or transaction hash" 
                               style="padding: 12px; background: rgba(15, 23, 42, 0.6); border: 2px solid rgba(96, 165, 250, 0.3); border-radius: 6px; color: #cbd5e1; font-family: monospace; font-size: 13px;">
                        <div style="display: flex; gap: 8px;">
                            <button onclick="investigateAddress()" 
                                    style="padding: 12px 20px; background: linear-gradient(135deg, #3b82f6 0%, #9333ea 100%); border: none; border-radius: 6px; color: white; cursor: pointer; font-weight: bold; font-size: 13px;">
                                üîç Investigate
                            </button>
                            <button onclick="traceTransaction()" 
                                    style="padding: 12px 20px; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.5); border-radius: 6px; color: #ef4444; cursor: pointer; font-weight: bold; font-size: 13px;">
                                üîó Trace Flow
                            </button>
                        </div>
                    </div>
                    <div id="investigationResults" style="display: none; margin-top: 20px;">
                        <!-- Results will be populated here -->
                    </div>
                </div>
                
                <!-- Investigation Tools Grid -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <!-- Taint Analysis -->
                    <div style="background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; padding: 15px;">
                        <div style="color: #60a5fa; font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                            üß¨ Taint Analysis
                        </div>
                        <div style="color: #94a3b8; font-size: 12px; margin-bottom: 10px;">Trace fund flows and contamination paths</div>
                        <button onclick="runTaintAnalysis()" 
                                style="width: 100%; padding: 8px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 4px; color: #60a5fa; cursor: pointer; font-size: 12px;">
                            Run Analysis
                        </button>
                    </div>
                    
                    <!-- Address Clustering -->
                    <div style="background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; padding: 15px;">
                        <div style="color: #60a5fa; font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                            üîó Address Clustering
                        </div>
                        <div style="color: #94a3b8; font-size: 12px; margin-bottom: 10px;">Identify related addresses and entity clusters</div>
                        <button onclick="runAddressClustering()" 
                                style="width: 100%; padding: 8px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 4px; color: #60a5fa; cursor: pointer; font-size: 12px;">
                            Cluster Addresses
                        </button>
                    </div>
                    
                    <!-- Flow Visualization -->
                    <div style="background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; padding: 15px;">
                        <div style="color: #60a5fa; font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                            üìä Flow Visualization
                        </div>
                        <div style="color: #94a3b8; font-size: 12px; margin-bottom: 10px;">Visualize transaction flows and relationships</div>
                        <button onclick="visualizeFlow()" 
                                style="width: 100%; padding: 8px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 4px; color: #60a5fa; cursor: pointer; font-size: 12px;">
                            Generate Graph
                        </button>
                    </div>
                    
                    <!-- Cross-Chain Investigation -->
                    <div style="background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; padding: 15px;">
                        <div style="color: #60a5fa; font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                            üåê Cross-Chain Analysis
                        </div>
                        <div style="color: #94a3b8; font-size: 12px; margin-bottom: 10px;">Track addresses across multiple chains</div>
                        <button onclick="runCrossChainAnalysis()" 
                                style="width: 100%; padding: 8px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 4px; color: #60a5fa; cursor: pointer; font-size: 12px;">
                            Analyze Chains
                        </button>
                    </div>
                    
                    <!-- MEV Analysis -->
                    <div style="background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; padding: 15px;">
                        <div style="color: #60a5fa; font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                            ‚ö° MEV Detection
                        </div>
                        <div style="color: #94a3b8; font-size: 12px; margin-bottom: 10px;">Detect front-running and MEV activities</div>
                        <button onclick="detectMEV()" 
                                style="width: 100%; padding: 8px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 4px; color: #60a5fa; cursor: pointer; font-size: 12px;">
                            Scan MEV
                        </button>
                    </div>
                    
                    <!-- Risk Profiling -->
                    <div style="background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; padding: 15px;">
                        <div style="color: #60a5fa; font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                            üé≠ Risk Profiling
                        </div>
                        <div style="color: #94a3b8; font-size: 12px; margin-bottom: 10px;">Generate comprehensive risk profile</div>
                        <button onclick="generateRiskProfile()" 
                                style="width: 100%; padding: 8px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 4px; color: #60a5fa; cursor: pointer; font-size: 12px;">
                            Create Profile
                        </button>
                    </div>
                </div>
                
                <!-- OSINT Integration Links -->
                <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid rgba(148, 163, 184, 0.2);">
                    <h3 style="color: #60a5fa; font-size: 16px; margin-bottom: 15px;">üîó External Investigation Resources</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                        <a href="https://etherscan.io" target="_blank" 
                           style="padding: 10px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 6px; color: #60a5fa; text-decoration: none; font-size: 12px; text-align: center; transition: all 0.2s;">
                            üîç Etherscan
                        </a>
                        <a href="https://www.blockchain.com/explorer" target="_blank" 
                           style="padding: 10px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 6px; color: #60a5fa; text-decoration: none; font-size: 12px; text-align: center; transition: all 0.2s;">
                            üîó Blockchain.com
                        </a>
                        <a href="https://breadcrumbs.app" target="_blank" 
                           style="padding: 10px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 6px; color: #60a5fa; text-decoration: none; font-size: 12px; text-align: center; transition: all 0.2s;">
                            üçû Breadcrumbs
                        </a>
                        <a href="https://dune.com" target="_blank" 
                           style="padding: 10px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 6px; color: #60a5fa; text-decoration: none; font-size: 12px; text-align: center; transition: all 0.2s;">
                            üìä Dune Analytics
                        </a>
                        <a href="https://www.oklink.com" target="_blank" 
                           style="padding: 10px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 6px; color: #60a5fa; text-decoration: none; font-size: 12px; text-align: center; transition: all 0.2s;">
                            üîé OKLink
                        </a>
                        <a href="https://misttrack.io" target="_blank" 
                           style="padding: 10px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 6px; color: #60a5fa; text-decoration: none; font-size: 12px; text-align: center; transition: all 0.2s;">
                            üïµÔ∏è MistTrack
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overall Risk Score (Dashboard Metrics - Keep for main dashboard) -->
        <div class="grid hide-on-financial-blockchain-tabs">
            <div class="card">
                <h2>üéØ Overall Risk Score</h2>
                <div class="metric-large" id="overallRisk">0</div>
                <div class="metric-label">Risk Assessment</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="riskProgress" style="width: 0%">0%</div>
                </div>
            </div>

            <div class="card">
                <h2>üí∞ Financial Health</h2>
                <div class="metric-large" id="financialHealth">0</div>
                <div class="metric-label">Health Score</div>
                <div id="financialStatus" class="status-badge status-healthy">Healthy</div>
                <div class="stat-row">
                    <span class="stat-label">Total Volume (24h)</span>
                    <span class="stat-value" id="totalVolume24h">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Avg Transaction Size</span>
                    <span class="stat-value" id="avgTxSize">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Transaction Velocity</span>
                    <span class="stat-value" id="txVelocity">0/hr</span>
                </div>
            </div>

            <div class="card">
                <h2>‚úÖ Compliance Status</h2>
                <div class="stat-row">
                    <span class="stat-label">AML Compliance</span>
                    <span class="stat-value" id="amlCompliance">100%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="amlProgress" style="width: 100%">100%</div>
                </div>
                <div class="stat-row">
                    <span class="stat-label">KYC Compliance</span>
                    <span class="stat-value" id="kycCompliance">100%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="kycProgress" style="width: 100%">100%</div>
                </div>
            </div>
        </div>

        <!-- Risk Breakdown & Transaction Volume -->
        <div class="grid hide-on-financial-blockchain-tabs">
            <div class="card">
                <h2>üìä Risk Breakdown</h2>
                <div class="risk-distribution">
                    <div class="risk-segment high">
                        <div style="font-size: 24px; font-weight: bold;" id="highRiskCount">0</div>
                        <div style="font-size: 12px;">High Risk</div>
                    </div>
                    <div class="risk-segment medium">
                        <div style="font-size: 24px; font-weight: bold;" id="mediumRiskCount">0</div>
                        <div style="font-size: 12px;">Medium Risk</div>
                    </div>
                    <div class="risk-segment low">
                        <div style="font-size: 24px; font-weight: bold;" id="lowRiskCount">0</div>
                        <div style="font-size: 12px;">Low Risk</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>üìà Transaction Volume</h2>
                <div class="stat-row">
                    <span class="stat-label">Last 24 Hours</span>
                    <span class="stat-value" id="volume24h">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Last 7 Days</span>
                    <span class="stat-value" id="volume7d">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Last 30 Days</span>
                    <span class="stat-value" id="volume30d">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Trend</span>
                    <span class="stat-value" id="volumeTrend">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Growth Rate</span>
                    <span class="stat-value" id="growthRate">0%</span>
                </div>
            </div>

            <div class="card">
                <h2>üö® Suspicious Activity</h2>
                <div class="stat-row">
                    <span class="stat-label">Total Flagged</span>
                    <span class="stat-value" id="totalFlagged">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">High Priority</span>
                    <span class="stat-value" id="highPriority">0</span>
                </div>
            </div>
        </div>

        <!-- Compliance Violations & Recommendations -->
        <div class="grid hide-on-financial-blockchain-tabs">
            <div class="card">
                <h2>‚ö†Ô∏è Compliance Violations</h2>
                <div id="violationsList">
                    <p style="color: #6b7280; text-align: center; padding: 20px;">No violations detected</p>
                </div>
            </div>

            <div class="card">
                <h2>üí° Regulatory Recommendations</h2>
                <div id="recommendationsList">
                    <p style="color: #6b7280; text-align: center; padding: 20px;">No recommendations at this time</p>
                </div>
            </div>

            <div class="card">
                <h2>üìú DABA Compliance Details</h2>
                <div id="dabaDetails">
                    <p style="color: #10b981; text-align: center; padding: 20px;">‚úÖ All DABA requirements met</p>
                </div>
            </div>

            <div class="card hide-on-financial-blockchain-tabs">
                <h2>üîç Suspicious Patterns</h2>
                <div id="patternsList">
                    <p style="color: #6b7280; text-align: center; padding: 20px;">No patterns detected</p>
                </div>
            </div>
        </div>

        <!-- RED-FLAGGED SUSPICIOUS WALLETS - DEDICATED COLUMN - Hidden on Financial Statements and Blockchain Monitor tabs -->
        <div class="card hide-on-financial-blockchain-tabs" style="margin-bottom: 20px; border: 3px solid #ef4444; background: linear-gradient(135deg, #fee2e2 0%, #fef2f2 100%);">
            <h2 class="section-title" style="color: #dc2626; display: flex; align-items: center; gap: 10px;">
                üö© RED-FLAGGED SUSPICIOUS WALLETS
                <span style="font-size: 14px; background: #dc2626; color: white; padding: 4px 12px; border-radius: 20px; font-weight: bold;" id="redFlaggedCount">0</span>
            </h2>
            <div style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="walletSearchInput" placeholder="Enter wallet address to trace..." 
                           style="flex: 1; padding: 10px; border: 2px solid #ef4444; border-radius: 6px; font-family: monospace;">
                    <button onclick="traceWallet()" 
                            style="padding: 10px 20px; background: #dc2626; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                        üîç Trace Wallet
                    </button>
                </div>
            </div>
            <div id="suspiciousWalletsList" style="max-height: 600px; overflow-y: auto;">
                <div style="text-align: center; padding: 40px; background: white; border-radius: 8px; border: 2px dashed #e5e7eb;">
                    <p style="color: #6b7280; margin-bottom: 10px; font-size: 16px;">No red-flagged suspicious wallets detected</p>
                    <p style="font-size: 12px; color: #9ca3af;">Wallets with risk score >= 70 will appear here</p>
                </div>
            </div>
        </div>

        <!-- High-Risk Transaction Flow Tracking - Hidden on Financial Statements and Blockchain Monitor tabs -->
        <div class="card hide-on-financial-blockchain-tabs" style="margin-bottom: 20px;">
            <h2 class="section-title">üî¥ High-Risk Transaction Flow Analysis</h2>
            <div id="highRiskFlowSection">
                <div class="flow-container" id="highRiskTransactions">
                    <div style="text-align: center; padding: 30px; background: #f9fafb; border-radius: 8px;">
                        <p style="color: #6b7280; margin-bottom: 10px;">No high-risk transactions detected</p>
                        <p style="font-size: 12px; color: #9ca3af;">Transactions with risk score >= 70 will appear here</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chain Analysis for High-Risk Transactions - Hidden on Financial Statements and Blockchain Monitor tabs -->
        <div class="card hide-on-financial-blockchain-tabs" style="margin-bottom: 20px;">
            <h2 class="section-title">üåê Chain Analysis - High-Risk Transactions</h2>
            <div class="chain-analysis-grid" id="chainAnalysisGrid">
                <div style="text-align: center; padding: 30px; background: #f9fafb; border-radius: 8px; grid-column: 1/-1;">
                    <p style="color: #6b7280; margin-bottom: 10px;">No chain analysis data available</p>
                    <p style="font-size: 12px; color: #9ca3af;">Chain analysis will appear when high-risk transactions are detected</p>
                </div>
            </div>
        </div>

        <!-- Flow Paths Visualization - Hidden on Financial Statements and Blockchain Monitor tabs -->
        <div class="card hide-on-financial-blockchain-tabs" style="margin-bottom: 20px;">
            <h2 class="section-title">üîÑ Transaction Flow Paths</h2>
            <div id="flowPathsSection">
                <div style="text-align: center; padding: 30px; background: #f9fafb; border-radius: 8px;">
                    <p style="color: #6b7280; margin-bottom: 10px;">No flow paths detected</p>
                    <p style="font-size: 12px; color: #9ca3af;">Flow paths are built from connected high-risk transactions</p>
                </div>
            </div>
        </div>

        <!-- Flow-Based Recommendations - Hidden on Financial Statements and Blockchain Monitor tabs -->
        <div class="card hide-on-financial-blockchain-tabs" style="margin-bottom: 20px;">
            <h2 class="section-title">üí° Flow-Based Recommendations</h2>
            <div id="flowRecommendations">
                <div style="text-align: center; padding: 30px; background: #f9fafb; border-radius: 8px;">
                    <p style="color: #6b7280; margin-bottom: 10px;">No specific recommendations</p>
                    <p style="font-size: 12px; color: #9ca3af;">Recommendations are generated from flow path analysis</p>
                </div>
            </div>
        </div>

        <!-- OpenZeppelin Monitor Section - Hidden on Financial Statements and Blockchain Monitor tabs -->
        <div class="card hide-on-financial-blockchain-tabs" style="margin-bottom: 20px;">
            <h2>üì° OpenZeppelin Monitor Triggers</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-bottom: 20px;" id="monitorTriggers">
                <div style="text-align: center; padding: 30px; background: #f9fafb; border-radius: 8px; grid-column: 1/-1;">
                    <p style="color: #6b7280; margin-bottom: 10px;">No triggers configured</p>
                    <p style="font-size: 12px; color: #9ca3af;">Triggers are loaded from monitor-triggers.json</p>
                </div>
            </div>
        </div>

        <div class="card hide-on-financial-blockchain-tabs">
            <h2>üìä Monitor Events</h2>
            <div id="monitorEvents" style="max-height: 500px; overflow-y: auto;">
                <div style="text-align: center; padding: 30px; background: #f9fafb; border-radius: 8px;">
                    <p style="color: #6b7280; margin-bottom: 10px;">No events triggered</p>
                    <p style="font-size: 12px; color: #9ca3af;">Events are generated when monitor triggers match transaction conditions</p>
                </div>
            </div>
        </div>

        <!-- Enhanced Suspicious Activity Report - Hidden on Financial Statements and Blockchain Monitor tabs -->
        <div class="card hide-on-financial-blockchain-tabs" style="margin-bottom: 20px; border: 2px solid #ef4444;">
            <h2 class="section-title" style="color: #dc2626;">üö® Enhanced Suspicious Activity Report</h2>
            <div id="enhancedSuspiciousActivity" style="margin-bottom: 20px;">
                <div style="text-align: center; padding: 30px; background: #f9fafb; border-radius: 8px;">
                    <p style="color: #6b7280; margin-bottom: 10px;">No enhanced suspicious activity detected</p>
                    <p style="font-size: 12px; color: #9ca3af;">Tracking flagged addresses with detailed activity information</p>
                </div>
            </div>
        </div>

        <!-- Market Manipulation Alerts (Pump and Dump Detection) - Hidden on Financial Statements and Blockchain Monitor tabs -->
        <div class="card hide-on-financial-blockchain-tabs" style="margin-bottom: 20px; border: 2px solid #dc2626;">
            <h2 class="section-title" style="color: #dc2626;">üö® Market Manipulation Alerts (Pump & Dump Detection)</h2>
            <div id="marketManipulationAlerts" style="max-height: 500px; overflow-y: auto;">
                <div style="text-align: center; padding: 30px; background: #f9fafb; border-radius: 8px;">
                    <p style="color: #6b7280; margin-bottom: 10px;">No market manipulation alerts</p>
                    <p style="font-size: 12px; color: #9ca3af;">Monitoring for pump-and-dump schemes, price manipulation, and volume spikes</p>
                </div>
            </div>
        </div>

        <!-- Risk Typology Analysis - Hidden on Financial Statements and Blockchain Monitor tabs -->
        <div class="card hide-on-financial-blockchain-tabs" style="margin-bottom: 20px;">
            <h2 class="section-title">üîç Risk Typology Analysis - Most Common Patterns</h2>
            <div id="typologyAnalysis" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 20px;">
                <div style="text-align: center; padding: 30px; background: #f9fafb; border-radius: 8px; grid-column: 1/-1;">
                    <p style="color: #6b7280; margin-bottom: 10px;">No typology data available</p>
                    <p style="font-size: 12px; color: #9ca3af;">Analyzing risk patterns across all suspicious wallets</p>
                </div>
            </div>
        </div>

        <div class="last-updated">
            Last updated: <span id="lastUpdated">Never</span>
        </div>
    </div>

    <button class="refresh-btn" onclick="fetchRegulatoryData()">üîÑ Refresh</button>

    <script>
        function formatNumber(num) {
            if (num >= 1e18) return (num / 1e18).toFixed(4) + ' ETH';
            if (num >= 1e15) return (num / 1e15).toFixed(2) + ' PETH';
            if (num >= 1e12) return (num / 1e12).toFixed(2) + ' TWEI';
            return num.toString();
        }

        function formatWei(wei) {
            if (typeof wei === 'string') {
                const num = BigInt(wei);
                return formatNumber(Number(num));
            }
            return formatNumber(Number(wei));
        }

        function getRiskClass(score) {
            if (score >= 70) return 'high-risk';
            if (score >= 40) return 'medium-risk';
            return '';
        }

        function getStatusClass(status) {
            return `status-${status.replace('_', '-')}`;
        }

        function getSeverityClass(severity) {
            return severity.toLowerCase();
        }

        async function fetchRegulatoryData() {
            try {
                const [regulatoryResponse, dabaResponse, triggersResponse, eventsResponse,
                        highRiskResponse, chainAnalysisResponse, flowsResponse, recommendationsResponse,
                        suspiciousWalletsResponse, walletStatsResponse, typologiesResponse, regulatorySummaryResponse] = await Promise.all([
                    fetch('/api/regulatory'),
                    fetch('/api/daba'),
                    fetch('/api/monitor/triggers'),
                    fetch('/api/monitor/events?limit=50'),
                    fetch('/api/high-risk/transactions?limit=20'),
                    fetch('/api/high-risk/chains'),
                    fetch('/api/high-risk/flows?limit=10'),
                    fetch('/api/high-risk/recommendations'),
                    fetch('/api/wallets/suspicious?limit=50'),
                    fetch('/api/wallets/stats'),
                    fetch('/api/wallets/typologies'),
                    fetch('/api/regulatory/summary')
                ]);
                const regulatoryData = await regulatoryResponse.json();
                const dabaData = await dabaResponse.json().catch(() => null);
                const triggersData = await triggersResponse.json().catch(() => null);
                const eventsData = await eventsResponse.json().catch(() => null);
                const highRiskData = await highRiskResponse.json().catch(() => null);
                const chainAnalysisData = await chainAnalysisResponse.json().catch(() => null);
                const flowsData = await flowsResponse.json().catch(() => null);
                const recommendationsData = await recommendationsResponse.json().catch(() => null);
                const suspiciousWalletsData = await suspiciousWalletsResponse.json().catch(() => null);
                const walletStatsData = await walletStatsResponse.json().catch(() => null);
                const typologiesData = await typologiesResponse.json().catch(() => null);
                const regulatorySummaryData = await regulatorySummaryResponse.json().catch(() => null);
                const enhancedSuspiciousResponse = await fetch('/api/suspicious-activity/enhanced').catch(() => null);
                const marketManipulationResponse = await fetch('/api/market-manipulation/alerts?limit=50').catch((err) => {
                    console.error('‚ùå Error fetching market manipulation alerts:', err);
                    return null;
                });
                
                let enhancedSuspiciousData = null;
                let marketManipulationData = null;
                
                if (enhancedSuspiciousResponse) {
                    enhancedSuspiciousData = await enhancedSuspiciousResponse.json().catch((err) => {
                        console.error('Error parsing enhanced suspicious data:', err);
                        return null;
                    });
                }
                
                if (marketManipulationResponse) {
                    if (!marketManipulationResponse.ok) {
                        console.error('‚ùå Market manipulation API returned error:', marketManipulationResponse.status, marketManipulationResponse.statusText);
                    } else {
                        marketManipulationData = await marketManipulationResponse.json().catch((err) => {
                            console.error('‚ùå Error parsing market manipulation alerts JSON:', err);
                            return null;
                        });
                    }
                }
                
                // Log market manipulation data for debugging
                if (marketManipulationData) {
                    console.log('‚úÖ Market Manipulation Alerts fetched:', marketManipulationData.alerts?.length || 0, 'alerts');
                    if (marketManipulationData.alerts && marketManipulationData.alerts.length > 0) {
                        console.log('üìä Sample alert:', marketManipulationData.alerts[0]);
                    }
                } else {
                    console.warn('‚ö†Ô∏è No market manipulation data received - API may not be initialized or no alerts yet');
                }
                updateDashboard(regulatoryData, dabaData, triggersData, eventsData, 
                              highRiskData, chainAnalysisData, flowsData, recommendationsData,
                              suspiciousWalletsData, walletStatsData, typologiesData, enhancedSuspiciousData, marketManipulationData, regulatorySummaryData);
            } catch (error) {
                console.error('Failed to fetch regulatory data:', error);
                // Hide error from user - only log to console
                const lastUpdated = document.getElementById('lastUpdated');
                if (lastUpdated) {
                    lastUpdated.textContent = new Date().toLocaleString();
                    lastUpdated.style.color = '#6b7280';
                }
            }
        }

        function updateDashboard(data, dabaData = null, triggersData = null, eventsData = null,
                                 highRiskData = null, chainAnalysisData = null, flowsData = null, recommendationsData = null,
                                 suspiciousWalletsData = null, walletStatsData = null, typologiesData = null, enhancedSuspiciousData = null, marketManipulationData = null, regulatorySummaryData = null) {
            
            // Update Regulatory Summary FIRST (most important for regulators)
            if (regulatorySummaryData) {
                // Overall risk level
                const riskLevelEl = document.getElementById('summaryOverallRiskLevel');
                if (riskLevelEl) {
                    riskLevelEl.textContent = regulatorySummaryData.overallRiskLevel || 'LOW';
                    const riskColor = regulatorySummaryData.overallRiskLevel === 'CRITICAL' ? '#dc2626' : 
                                     regulatorySummaryData.overallRiskLevel === 'HIGH' ? '#f59e0b' :
                                     regulatorySummaryData.overallRiskLevel === 'MODERATE' ? '#fbbf24' : '#10b981';
                    riskLevelEl.style.color = riskColor;
                }
                
                // Counts
                document.getElementById('summaryCriticalCount').textContent = regulatorySummaryData.criticalAddresses?.length || 0;
                document.getElementById('summaryHighRiskCount').textContent = regulatorySummaryData.highRiskAddresses?.length || 0;
                document.getElementById('summaryTotalSuspicious').textContent = regulatorySummaryData.suspiciousAddressesCount || 0;
                
                // Critical addresses
                const criticalListEl = document.getElementById('criticalAddressesList');
                if (criticalListEl) {
                    if (regulatorySummaryData.criticalAddresses && regulatorySummaryData.criticalAddresses.length > 0) {
                        criticalListEl.innerHTML = regulatorySummaryData.criticalAddresses.map(addr => `
                            <div style="background: #fee2e2; border: 3px solid #dc2626; border-radius: 10px; padding: 20px; margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: bold; font-size: 18px; color: #dc2626; margin-bottom: 5px;">
                                            üî¥ CRITICAL RISK: ${addr.riskScore}/100
                                        </div>
                                        <div style="font-family: monospace; font-size: 14px; color: #991b1b; margin-bottom: 10px; word-break: break-all;">
                                            ${addr.address}
                                        </div>
                                        <div style="font-size: 13px; color: #991b1b; line-height: 1.6;">
                                            ${addr.summary}
                                        </div>
                                    </div>
                                    <div style="text-align: right; margin-left: 20px;">
                                        <div style="background: #dc2626; color: white; padding: 8px 16px; border-radius: 6px; font-weight: bold; margin-bottom: 10px;">
                                            ${addr.riskLevel}
                                        </div>
                                        <div style="font-size: 12px; color: #6b7280;">
                                            ${addr.transactionCount} TXs
                                        </div>
                                        <div style="font-size: 12px; color: #6b7280;">
                                            ${addr.chains.length} Chains
                                        </div>
                                    </div>
                                </div>
                                <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #dc2626;">
                                    <div style="font-size: 12px; font-weight: bold; color: #991b1b; margin-bottom: 8px;">RISK FACTORS:</div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                        ${addr.reasons.map(r => `<span style="padding: 6px 12px; background: #dc2626; color: white; border-radius: 6px; font-size: 11px; font-weight: bold;">${r}</span>`).join('')}
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        criticalListEl.innerHTML = '<p style="color: #10b981; text-align: center; padding: 20px; font-weight: bold;">‚úÖ No critical addresses detected</p>';
                    }
                }
                
                // Risk categories with address lists
                if (regulatorySummaryData.riskCategories) {
                    const cats = regulatorySummaryData.riskCategories;
                    
                    // Rapid Transactions
                    if (cats.rapidTransactions) {
                        document.getElementById('catRapidTx').textContent = cats.rapidTransactions.count || 0;
                        const rapidListEl = document.getElementById('rapidTxList');
                        if (rapidListEl && cats.rapidTransactions.addresses && cats.rapidTransactions.addresses.length > 0) {
                            rapidListEl.innerHTML = cats.rapidTransactions.addresses.map(addr => `
                                <div style="padding: 15px; margin-bottom: 10px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 8px; cursor: pointer;" onclick="traceWallet('${addr.address}')">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div style="flex: 1;">
                                            <div style="font-family: monospace; font-size: 13px; font-weight: bold; color: #92400e; margin-bottom: 8px; word-break: break-all;">
                                                ${addr.address}
                                            </div>
                                            <div style="font-size: 12px; color: #92400e; line-height: 1.5;">
                                                ${addr.summary}
                                            </div>
                                        </div>
                                        <div style="text-align: right; margin-left: 15px;">
                                            <div style="font-size: 16px; font-weight: bold; color: #d97706;">Risk: ${Math.round(addr.riskScore)}</div>
                                            <div style="font-size: 11px; color: #92400e; margin-top: 5px;">${addr.transactionCount} TXs</div>
                                        </div>
                                    </div>
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(217, 119, 6, 0.2);">
                                        <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                            ${addr.reasons.map(r => `<span style="padding: 4px 8px; background: #f59e0b; color: white; border-radius: 4px; font-size: 10px;">${r}</span>`).join('')}
                                        </div>
                                    </div>
                                </div>
                            `).join('');
                        } else if (rapidListEl) {
                            rapidListEl.innerHTML = '<p style="color: #10b981; text-align: center; padding: 20px;">‚úÖ No rapid transaction addresses detected</p>';
                        }
                    }
                    
                    // Large Value Transactions
                    if (cats.largeValueTransactions) {
                        document.getElementById('catLargeValue').textContent = cats.largeValueTransactions.count || 0;
                        const largeListEl = document.getElementById('largeValueList');
                        if (largeListEl && cats.largeValueTransactions.addresses && cats.largeValueTransactions.addresses.length > 0) {
                            largeListEl.innerHTML = cats.largeValueTransactions.addresses.map(addr => `
                                <div style="padding: 15px; margin-bottom: 10px; background: #fee2e2; border-left: 4px solid #dc2626; border-radius: 8px; cursor: pointer;" onclick="traceWallet('${addr.address}')">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div style="flex: 1;">
                                            <div style="font-family: monospace; font-size: 13px; font-weight: bold; color: #dc2626; margin-bottom: 8px; word-break: break-all;">
                                                ${addr.address}
                                            </div>
                                            <div style="font-size: 12px; color: #991b1b; line-height: 1.5;">
                                                ${addr.summary}
                                            </div>
                                        </div>
                                        <div style="text-align: right; margin-left: 15px;">
                                            <div style="font-size: 16px; font-weight: bold; color: #dc2626;">Risk: ${Math.round(addr.riskScore)}</div>
                                            <div style="font-size: 11px; color: #991b1b; margin-top: 5px;">${addr.transactionCount} TXs</div>
                                        </div>
                                    </div>
                                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(220, 38, 38, 0.2);">
                                        <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                            ${addr.reasons.map(r => `<span style="padding: 4px 8px; background: #dc2626; color: white; border-radius: 4px; font-size: 10px;">${r}</span>`).join('')}
                                        </div>
                                    </div>
                                </div>
                            `).join('');
                        } else if (largeListEl) {
                            largeListEl.innerHTML = '<p style="color: #10b981; text-align: center; padding: 20px;">‚úÖ No large value transaction addresses detected</p>';
                        }
                    }
                    
                    // Structuring
                    if (cats.structuring) {
                        document.getElementById('catStructuring').textContent = cats.structuring.count || 0;
                        const structListEl = document.getElementById('structuringList');
                        if (structListEl && cats.structuring.addresses && cats.structuring.addresses.length > 0) {
                            structListEl.innerHTML = cats.structuring.addresses.map(addr => `
                                <div style="padding: 15px; margin-bottom: 10px; background: #fee2e2; border-left: 4px solid #dc2626; border-radius: 8px; cursor: pointer;" onclick="traceWallet('${addr.address}')">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div style="flex: 1;">
                                            <div style="font-family: monospace; font-size: 13px; font-weight: bold; color: #dc2626; margin-bottom: 8px; word-break: break-all;">
                                                ${addr.address}
                                            </div>
                                            <div style="font-size: 12px; color: #991b1b; line-height: 1.5;">
                                                ${addr.summary}
                                            </div>
                                        </div>
                                        <div style="text-align: right; margin-left: 15px;">
                                            <div style="font-size: 16px; font-weight: bold; color: #dc2626;">Risk: ${Math.round(addr.riskScore)}</div>
                                            <div style="font-size: 11px; color: #991b1b; margin-top: 5px;">${addr.transactionCount} TXs</div>
                                        </div>
                                    </div>
                                </div>
                            `).join('');
                        } else if (structListEl) {
                            structListEl.innerHTML = '<p style="color: #10b981; text-align: center; padding: 20px;">‚úÖ No structuring addresses detected</p>';
                        }
                    }
                    
                    // Multi-Chain
                    if (cats.multiChainActivity) {
                        document.getElementById('catMultiChain').textContent = cats.multiChainActivity.count || 0;
                        const multiListEl = document.getElementById('multiChainList');
                        if (multiListEl && cats.multiChainActivity.addresses && cats.multiChainActivity.addresses.length > 0) {
                            multiListEl.innerHTML = cats.multiChainActivity.addresses.map(addr => `
                                <div style="padding: 15px; margin-bottom: 10px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 8px; cursor: pointer;" onclick="traceWallet('${addr.address}')">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div style="flex: 1;">
                                            <div style="font-family: monospace; font-size: 13px; font-weight: bold; color: #92400e; margin-bottom: 8px; word-break: break-all;">
                                                ${addr.address}
                                            </div>
                                            <div style="font-size: 12px; color: #92400e; line-height: 1.5;">
                                                ${addr.summary}
                                            </div>
                                        </div>
                                        <div style="text-align: right; margin-left: 15px;">
                                            <div style="font-size: 16px; font-weight: bold; color: #d97706;">Risk: ${Math.round(addr.riskScore)}</div>
                                            <div style="font-size: 11px; color: #92400e; margin-top: 5px;">${addr.chains ? addr.chains.length : 0} Chains</div>
                                        </div>
                                    </div>
                                </div>
                            `).join('');
                        } else if (multiListEl) {
                            multiListEl.innerHTML = '<p style="color: #10b981; text-align: center; padding: 20px;">‚úÖ No multi-chain addresses detected</p>';
                        }
                    }
                    
                    // High Connections
                    if (cats.highConnections) {
                        document.getElementById('catHighConn').textContent = cats.highConnections.count || 0;
                        const connListEl = document.getElementById('highConnList');
                        if (connListEl && cats.highConnections.addresses && cats.highConnections.addresses.length > 0) {
                            connListEl.innerHTML = cats.highConnections.addresses.map(addr => `
                                <div style="padding: 15px; margin-bottom: 10px; background: #fef3c7; border-left: 4px solid #f59e0b; border-radius: 8px; cursor: pointer;" onclick="traceWallet('${addr.address}')">
                                    <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div style="flex: 1;">
                                            <div style="font-family: monospace; font-size: 13px; font-weight: bold; color: #92400e; margin-bottom: 8px; word-break: break-all;">
                                                ${addr.address}
                                            </div>
                                            <div style="font-size: 12px; color: #92400e; line-height: 1.5;">
                                                ${addr.summary}
                                            </div>
                                        </div>
                                        <div style="text-align: right; margin-left: 15px;">
                                            <div style="font-size: 16px; font-weight: bold; color: #d97706;">Risk: ${Math.round(addr.riskScore)}</div>
                                            <div style="font-size: 11px; color: #92400e; margin-top: 5px;">${addr.connectedAddresses || 0} Connections</div>
                                        </div>
                                    </div>
                                </div>
                            `).join('');
                        } else if (connListEl) {
                            connListEl.innerHTML = '<p style="color: #10b981; text-align: center; padding: 20px;">‚úÖ No high-connection addresses detected</p>';
                        }
                    }
                }
                
                // Recommendations
                const recEl = document.getElementById('regulatoryRecommendations');
                if (recEl) {
                    if (regulatorySummaryData.recommendations && regulatorySummaryData.recommendations.length > 0) {
                        recEl.innerHTML = regulatorySummaryData.recommendations.map(rec => `
                            <div style="padding: 12px; margin-bottom: 10px; background: white; border-left: 4px solid #3b82f6; border-radius: 6px;">
                                <div style="font-size: 14px; color: #1e40af; line-height: 1.6;">${rec}</div>
                            </div>
                        `).join('');
                    } else {
                        recEl.innerHTML = '<p style="color: #10b981; text-align: center; padding: 10px;">‚úÖ No immediate recommendations at this time</p>';
                    }
                }
            }
            // Only log errors, not every update (too verbose)
            if (!data) {
                console.error('No regulatory data received!');
                return;
            }
            
            // Log data counts for debugging
            const dataCounts = {
                riskHigh: data.riskBreakdown?.highRisk || 0,
                riskMedium: data.riskBreakdown?.mediumRisk || 0,
                riskLow: data.riskBreakdown?.lowRisk || 0,
                volume24h: data.transactionVolume?.last24h || 0,
                suspicious: data.suspiciousActivity?.totalFlagged || 0,
                violations: data.complianceStatus?.violations?.length || 0,
            };
            console.log('üìä Dashboard Update:', dataCounts);

            // Update DABA Compliance
            if (dabaData) {
                document.getElementById('dabaOverall').textContent = dabaData.overallCompliance || 0;
                document.getElementById('dabaLicense').textContent = dabaData.licensing?.licenseClass || '-';
                document.getElementById('dabaStatus').textContent = (dabaData.licensing?.status || '-').toUpperCase();
                document.getElementById('dabaCustody').textContent = (dabaData.clientAssetCustody?.custodyScore || 0) + '%';
                document.getElementById('dabaCyber').textContent = (dabaData.cyberRiskManagement?.cyberRiskScore || 0) + '%';
                document.getElementById('dabaAML').textContent = (dabaData.amlAtfCompliance?.amlAtfScore || 0) + '%';
                document.getElementById('dabaReporting').textContent = (dabaData.regulatoryReporting?.reportingScore || 0) + '%';

                // DABA Details
                const dabaDetails = document.getElementById('dabaDetails');
                const issues = [];
                if (dabaData.clientAssetCustody?.issues?.length) issues.push(...dabaData.clientAssetCustody.issues);
                if (dabaData.cyberRiskManagement?.vulnerabilities?.length) issues.push(...dabaData.cyberRiskManagement.vulnerabilities);
                if (dabaData.amlAtfCompliance?.violations?.length) issues.push(...dabaData.amlAtfCompliance.violations);
                if (dabaData.operationalRequirements?.deficiencies?.length) issues.push(...dabaData.operationalRequirements.deficiencies);

                if (issues.length === 0) {
                    dabaDetails.innerHTML = '<p style="color: #10b981; text-align: center; padding: 20px;">‚úÖ All DABA requirements met</p>';
                } else {
                    dabaDetails.innerHTML = issues.map(issue => `
                        <div class="violation-item medium">
                            <small>${issue}</small>
                        </div>
                    `).join('');
                }
            }

            // Multi-Chain Data with Charts
            const chainDataEl = document.getElementById('multiChainData');
            if (data && data.multiChainData && data.multiChainData.length > 0) {
                // Update charts
                updateChainCharts(data.multiChainData);
                
                if (chainDataEl) {
                    chainDataEl.innerHTML = data.multiChainData.map(chain => `
                        <div style="padding: 15px; background: #f9fafb; border-radius: 8px; border-left: 4px solid #3b82f6;">
                            <div style="font-weight: bold; margin-bottom: 10px; text-transform: uppercase;">${chain.chain}</div>
                            <div class="stat-row">
                                <span class="stat-label">Transactions</span>
                                <span class="stat-value">${chain.transactionCount || 0}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Volume</span>
                                <span class="stat-value">${formatWei(chain.volume || 0)}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Avg Risk</span>
                                <span class="stat-value">${Math.round(chain.riskScore || 0)}</span>
                            </div>
                        </div>
                    `).join('');
                }
            } else if (chainDataEl) {
                // Show empty state with message
                chainDataEl.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px; grid-column: 1/-1;">No chain data available. Data will appear as transactions are processed.</p>';
            }
            // Overall Risk Score
            if (data && data.overallRiskScore !== undefined) {
                const riskScore = Math.round(data.overallRiskScore || 0);
                const riskEl = document.getElementById('overallRisk');
                if (riskEl) riskEl.textContent = riskScore;
                const riskProgress = document.getElementById('riskProgress');
                if (riskProgress) {
                    riskProgress.style.width = riskScore + '%';
                    riskProgress.textContent = riskScore + '%';
                    riskProgress.className = 'progress-fill ' + getRiskClass(riskScore);
                }
            }

            // Financial Health
            if (data && data.financialHealth) {
                const financial = data.financialHealth;
                const healthScore = Math.round(financial.score || 0);
                const healthEl = document.getElementById('financialHealth');
                if (healthEl) {
                    healthEl.textContent = healthScore;
                }
                const statusBadge = document.getElementById('financialStatus');
                if (statusBadge) {
                    statusBadge.textContent = (financial.status || 'healthy').replace('_', ' ').toUpperCase();
                    statusBadge.className = 'status-badge ' + getStatusClass(financial.status || 'healthy');
                }
                
                // Financial indicators
                const indicators = financial.indicators || {};
                const vol24hEl = document.getElementById('totalVolume24h');
                const avgTxEl = document.getElementById('avgTxSize');
                const txVelEl = document.getElementById('txVelocity');
                if (vol24hEl) vol24hEl.textContent = formatWei(indicators.totalVolume || 0);
                if (avgTxEl) avgTxEl.textContent = formatWei(indicators.averageTransactionSize || 0);
                if (txVelEl) txVelEl.textContent = (indicators.velocity || 0).toFixed(1) + '/hr';
            }

            // Compliance
            if (data && data.complianceStatus) {
                const compliance = data.complianceStatus;
                const aml = Math.round(compliance.amlCompliance || 100);
                const kyc = Math.round(compliance.kycCompliance || 100);
                const amlEl = document.getElementById('amlCompliance');
                const kycEl = document.getElementById('kycCompliance');
                const amlProg = document.getElementById('amlProgress');
                const kycProg = document.getElementById('kycProgress');
                if (amlEl) amlEl.textContent = aml + '%';
                if (kycEl) kycEl.textContent = kyc + '%';
                if (amlProg) amlProg.style.width = aml + '%';
                if (kycProg) kycProg.style.width = kyc + '%';
            }

            // Risk Breakdown
            if (data && data.riskBreakdown) {
                const risk = data.riskBreakdown;
                const highRiskEl = document.getElementById('highRiskCount');
                const mediumRiskEl = document.getElementById('mediumRiskCount');
                const lowRiskEl = document.getElementById('lowRiskCount');
                if (highRiskEl) highRiskEl.textContent = risk.highRisk || 0;
                if (mediumRiskEl) mediumRiskEl.textContent = risk.mediumRisk || 0;
                if (lowRiskEl) lowRiskEl.textContent = risk.lowRisk || 0;
            }

            // Transaction Volume
            if (data && data.transactionVolume) {
                const volume = data.transactionVolume;
                const vol24h = document.getElementById('volume24h');
                const vol7d = document.getElementById('volume7d');
                const vol30d = document.getElementById('volume30d');
                const volTrend = document.getElementById('volumeTrend');
                const growthRate = document.getElementById('growthRate');
                if (vol24h) {
                    const val = volume.last24h || 0;
                    vol24h.textContent = val > 0 ? formatWei(val) : '0';
                }
                if (vol7d) {
                    const val = volume.last7d || 0;
                    vol7d.textContent = val > 0 ? formatWei(val) : '0';
                }
                if (vol30d) {
                    const val = volume.last30d || 0;
                    vol30d.textContent = val > 0 ? formatWei(val) : '0';
                }
                if (volTrend) volTrend.textContent = (volume.trend || 'stable').toUpperCase();
                if (growthRate) growthRate.textContent = (volume.growthRate || 0).toFixed(2) + '%';
            } else {
                // Show 0 if no data
                const vol24h = document.getElementById('volume24h');
                const vol7d = document.getElementById('volume7d');
                const vol30d = document.getElementById('volume30d');
                if (vol24h) vol24h.textContent = '0';
                if (vol7d) vol7d.textContent = '0';
                if (vol30d) vol30d.textContent = '0';
            }

            // Suspicious Activity
            if (data && data.suspiciousActivity) {
                const suspicious = data.suspiciousActivity;
                const totalFlaggedEl = document.getElementById('totalFlagged');
                const highPriorityEl = document.getElementById('highPriority');
                if (totalFlaggedEl) {
                    const val = suspicious.totalFlagged || 0;
                    totalFlaggedEl.textContent = val.toString();
                    totalFlaggedEl.style.color = val > 0 ? '#ef4444' : '#6b7280';
                }
                if (highPriorityEl) {
                    const val = suspicious.highPriority || 0;
                    highPriorityEl.textContent = val.toString();
                    highPriorityEl.style.color = val > 0 ? '#ef4444' : '#6b7280';
                }
            } else {
                const totalFlaggedEl = document.getElementById('totalFlagged');
                const highPriorityEl = document.getElementById('highPriority');
                if (totalFlaggedEl) totalFlaggedEl.textContent = '0';
                if (highPriorityEl) highPriorityEl.textContent = '0';
            }

            // Violations
            if (data && data.complianceStatus && data.complianceStatus.violations) {
                const violations = data.complianceStatus.violations || [];
                const violationsList = document.getElementById('violationsList');
                if (violationsList) {
                    if (violations.length === 0) {
                        violationsList.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">No violations detected</p>';
                    } else {
                        violationsList.innerHTML = violations.map(v => `
                            <div class="violation-item ${getSeverityClass(v.severity)}">
                                <strong>${v.type}</strong> - ${v.severity.toUpperCase()}<br>
                                <small>${v.description}</small>
                            </div>
                        `).join('');
                    }
                }
            }

            // Recommendations
            if (data && data.recommendations) {
                const recommendations = data.recommendations || [];
                const recList = document.getElementById('recommendationsList');
                if (recList) {
                    if (recommendations.length === 0) {
                        recList.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">No recommendations at this time</p>';
                    } else {
                        recList.innerHTML = recommendations.map(r => `
                            <div class="recommendation-item">${r}</div>
                        `).join('');
                    }
                }
            }

            // Patterns
            if (data && data.suspiciousActivity && data.suspiciousActivity.patterns) {
                const patterns = data.suspiciousActivity.patterns || [];
                const patternsList = document.getElementById('patternsList');
                if (patternsList) {
                    if (patterns.length === 0) {
                        patternsList.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">No patterns detected</p>';
                    } else {
                        patternsList.innerHTML = patterns.map(p => `
                            <div class="pattern-item">
                                <span>${p.type}</span>
                                <strong>${p.count}</strong>
                            </div>
                        `).join('');
                    }
                }
            }

            // Alert Banner
            if (data) {
                const alertBanner = document.getElementById('alertBanner');
                const alertMessage = document.getElementById('alertMessage');
                if (alertBanner && alertMessage) {
                    const currentRiskScore = data.overallRiskScore || 0;
                    const currentHealth = data.financialHealth?.score || 100;
                    const currentAml = data.complianceStatus?.amlCompliance || 100;
                    const currentKyc = data.complianceStatus?.kycCompliance || 100;
                    
                    if (currentRiskScore >= 70 || currentHealth < 40 || currentAml < 70 || currentKyc < 70) {
                        alertBanner.style.display = 'block';
                        alertBanner.className = currentRiskScore >= 80 ? 'alert-banner critical' : 'alert-banner';
                        const alerts = [];
                        if (currentRiskScore >= 70) alerts.push('High overall risk detected');
                        if (currentHealth < 40) alerts.push('Financial health critical');
                        if (currentAml < 70) alerts.push('AML compliance below threshold');
                        if (currentKyc < 70) alerts.push('KYC compliance below threshold');
                        alertMessage.textContent = alerts.join(' | ');
                    } else {
                        alertBanner.style.display = 'none';
                    }
                }
            }

            // High-Risk Transactions
            const highRiskEl = document.getElementById('highRiskTransactions');
            if (highRiskEl) {
                if (highRiskData && highRiskData.transactions && highRiskData.transactions.length > 0) {
                    highRiskEl.innerHTML = highRiskData.transactions.map(tx => `
                        <div class="flow-item">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div>
                                    <div style="font-weight: bold; font-size: 16px; color: #991b1b; margin-bottom: 5px;">
                                        Risk Score: ${Math.round(tx.riskScore)}/100
                                    </div>
                                    <div style="font-size: 12px; color: #6b7280;">
                                        ${new Date(tx.timestamp).toLocaleString()}
                                    </div>
                                </div>
                                <span class="chain-badge">${tx.chain.toUpperCase()}</span>
                            </div>
                            <div class="flow-path">
                                <div style="flex: 1;">
                                    <div style="font-size: 11px; color: #6b7280; margin-bottom: 5px;">FROM</div>
                                    <a href="#" class="address-link" title="${tx.sourceAddress}">
                                        ${tx.sourceAddress.slice(0, 10)}...${tx.sourceAddress.slice(-8)}
                                    </a>
                                </div>
                                <span class="flow-arrow">‚Üí</span>
                                <div style="flex: 1;">
                                    <div style="font-size: 11px; color: #6b7280; margin-bottom: 5px;">TO</div>
                                    <a href="#" class="address-link" title="${tx.destinationAddress}">
                                        ${tx.destinationAddress === 'CONTRACT_CREATION' ? 'Contract Creation' : tx.destinationAddress.slice(0, 10) + '...' + tx.destinationAddress.slice(-8)}
                                    </a>
                                </div>
                            </div>
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(239, 68, 68, 0.2);">
                                <div style="font-size: 12px; color: #6b7280;">
                                    Value: ${formatWei(tx.value)} | 
                                    Hash: <a href="#" class="address-link" title="${tx.transactionHash}">${tx.transactionHash.slice(0, 20)}...</a>
                                </div>
                                ${tx.anomalyFlags ? `
                                    <div style="margin-top: 8px;">
                                        ${(Array.isArray(tx.anomalyFlags) ? tx.anomalyFlags : (typeof tx.anomalyFlags === 'string' ? tx.anomalyFlags.split(' ') : [])).map(flag => `<span style="display: inline-block; padding: 4px 8px; background: rgba(239, 68, 68, 0.1); border-radius: 4px; font-size: 10px; margin-right: 5px; margin-top: 5px;">${flag}</span>`).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `).join('');
                } else {
                    highRiskEl.innerHTML = '<div style="text-align: center; padding: 30px; background: #f9fafb; border-radius: 8px;"><p style="color: #6b7280; margin-bottom: 10px;">No high-risk transactions detected</p><p style="font-size: 12px; color: #9ca3af;">Transactions with risk score >= 70 will appear here</p></div>';
                }
            }

            // Chain Analysis
            const chainGrid = document.getElementById('chainAnalysisGrid');
            if (chainGrid) {
                // Debug log
                console.log('Chain Analysis Data:', chainAnalysisData);
                if (chainAnalysisData && chainAnalysisData.chains && Array.isArray(chainAnalysisData.chains) && chainAnalysisData.chains.length > 0) {
                    chainGrid.innerHTML = chainAnalysisData.chains.map(chain => `
                        <div class="chain-analysis-card">
                            <div style="font-weight: bold; font-size: 18px; color: #0ea5e9; margin-bottom: 15px; text-transform: uppercase;">
                                ${chain.chain}
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Transactions</span>
                                <span class="stat-value">${chain.transactionCount}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Total Value</span>
                                <span class="stat-value">${formatWei(chain.totalValue)}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Avg Risk</span>
                                <span class="stat-value">${Math.round(chain.averageRisk)}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">High-Risk Count</span>
                                <span class="stat-value" style="color: #ef4444;">${chain.highRiskCount}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Unique Addresses</span>
                                <span class="stat-value">${chain.uniqueAddresses}</span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    chainGrid.innerHTML = '<div style="text-align: center; padding: 30px; background: #f9fafb; border-radius: 8px; grid-column: 1/-1;"><p style="color: #6b7280; margin-bottom: 10px;">No chain analysis data available</p><p style="font-size: 12px; color: #9ca3af;">Chain analysis will appear when high-risk transactions are detected</p></div>';
                }
            }

            // Flow Paths
            const flowsEl = document.getElementById('flowPathsSection');
            if (flowsEl) {
                // Debug log
                console.log('Flow Paths Data:', flowsData);
                if (flowsData && flowsData.flows && Array.isArray(flowsData.flows) && flowsData.flows.length > 0) {
                    flowsEl.innerHTML = flowsData.flows.map((flow, idx) => `
                        <div class="flow-item" style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                                <div>
                                    <div style="font-weight: bold; font-size: 16px; color: #991b1b;">
                                        Flow Path #${idx + 1}
                                    </div>
                                    <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                                        ${flow.path.length} transactions across ${flow.chainsInvolved.length} chain(s)
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: bold; color: #ef4444;">${formatWei(flow.totalValue)}</div>
                                    <div style="font-size: 11px; color: #6b7280;">Total Value</div>
                                </div>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">Chains: ${flow.chainsInvolved.map(c => `<span class="chain-badge">${c}</span>`).join(' ')}</div>
                                <div style="font-size: 12px; color: #6b7280;">Average Risk: <strong>${Math.round(flow.averageRisk)}</strong></div>
                            </div>
                            <div style="background: rgba(255, 255, 255, 0.8); padding: 15px; border-radius: 8px; margin-top: 10px;">
                                <div style="font-size: 12px; font-weight: bold; color: #6b7280; margin-bottom: 10px;">Flow Path:</div>
                                ${flow.path.map((tx, txIdx) => `
                                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px; padding: 8px; background: rgba(239, 68, 68, 0.05); border-radius: 6px;">
                                        <span style="font-size: 11px; color: #6b7280; min-width: 60px;">Step ${txIdx + 1}</span>
                                        <span class="chain-badge" style="font-size: 10px;">${tx.chain}</span>
                                        <span style="flex: 1; font-size: 11px; font-family: monospace; color: #3b82f6;">
                                            ${tx.sourceAddress.slice(0, 8)}...${tx.sourceAddress.slice(-6)}
                                        </span>
                                        <span class="flow-arrow" style="font-size: 16px;">‚Üí</span>
                                        <span style="flex: 1; font-size: 11px; font-family: monospace; color: #3b82f6;">
                                            ${tx.destinationAddress === 'CONTRACT_CREATION' ? 'Contract' : tx.destinationAddress.slice(0, 8) + '...' + tx.destinationAddress.slice(-6)}
                                        </span>
                                        <span style="font-size: 11px; color: #ef4444; font-weight: bold;">Risk: ${Math.round(tx.riskScore)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('');
                } else {
                    flowsEl.innerHTML = '<div style="text-align: center; padding: 30px; background: #f9fafb; border-radius: 8px;"><p style="color: #6b7280; margin-bottom: 10px;">No flow paths detected</p><p style="font-size: 12px; color: #9ca3af;">Flow paths are built from connected high-risk transactions</p></div>';
                }
            }

            // Flow-Based Recommendations
            const recEl = document.getElementById('flowRecommendations');
            if (recEl) {
                // Debug log
                console.log('Recommendations Data:', recommendationsData);
                if (recommendationsData && recommendationsData.recommendations && Array.isArray(recommendationsData.recommendations) && recommendationsData.recommendations.length > 0) {
                    recEl.innerHTML = recommendationsData.recommendations.map(rec => `
                        <div class="recommendation-card">
                            <div style="font-size: 14px; line-height: 1.6; color: #1e40af;">
                                ${rec}
                            </div>
                        </div>
                    `).join('');
                } else {
                    recEl.innerHTML = '<div style="text-align: center; padding: 30px; background: #f9fafb; border-radius: 8px;"><p style="color: #6b7280; margin-bottom: 10px;">No specific recommendations</p><p style="font-size: 12px; color: #9ca3af;">Recommendations are generated from flow path analysis</p></div>';
                }
            }

            // Wallet Statistics
            if (walletStatsData) {
                const totalWalletsEl = document.getElementById('totalWallets');
                const suspiciousWalletsCountEl = document.getElementById('suspiciousWalletsCount');
                const highRiskWalletsCountEl = document.getElementById('highRiskWalletsCount');
                const walletRelationshipsEl = document.getElementById('walletRelationships');
                if (totalWalletsEl) totalWalletsEl.textContent = walletStatsData.totalWallets || 0;
                if (suspiciousWalletsCountEl) suspiciousWalletsCountEl.textContent = walletStatsData.suspiciousWallets || 0;
                if (highRiskWalletsCountEl) highRiskWalletsCountEl.textContent = walletStatsData.highRiskWallets || 0;
                if (walletRelationshipsEl) walletRelationshipsEl.textContent = walletStatsData.totalRelationships || 0;
            }

            // RED-FLAGGED SUSPICIOUS WALLETS LIST
            const walletsListEl = document.getElementById('suspiciousWalletsList');
            const redFlaggedCountEl = document.getElementById('redFlaggedCount');
            if (walletsListEl) {
                // Debug log
                console.log('Suspicious Wallets Data:', suspiciousWalletsData);
                if (suspiciousWalletsData && suspiciousWalletsData.wallets && Array.isArray(suspiciousWalletsData.wallets) && suspiciousWalletsData.wallets.length > 0) {
                    // Update count badge
                    if (redFlaggedCountEl) {
                        redFlaggedCountEl.textContent = suspiciousWalletsData.wallets.length;
                    }
                    
                    walletsListEl.innerHTML = suspiciousWalletsData.wallets.map((wallet, idx) => `
                        <div style="background: white; border: 3px solid #dc2626; border-radius: 12px; padding: 20px; margin-bottom: 15px; 
                                    box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3); cursor: pointer; transition: all 0.3s;"
                             onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 6px 16px rgba(220, 38, 38, 0.4)';"
                             onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(220, 38, 38, 0.3)';"
                             onclick="traceWallet('${wallet.address}')">
                            <div style="display: flex; align-items: start; gap: 15px; margin-bottom: 15px;">
                                <div style="background: #dc2626; color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; flex-shrink: 0;">
                                    üö©
                                </div>
                                <div style="flex: 1;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                        <div>
                                            <div style="font-weight: bold; font-size: 18px; color: #dc2626; margin-bottom: 5px;">
                                                üö® RED-FLAGGED WALLET #${idx + 1}
                                            </div>
                                            <div style="font-size: 14px; color: #991b1b; margin-bottom: 8px;">
                                                Risk Score: <strong>${Math.round(wallet.riskScore)}/100</strong>
                                            </div>
                                        </div>
                                        <div style="background: #fee2e2; padding: 8px 12px; border-radius: 6px; border: 2px solid #dc2626;">
                                            <div style="font-size: 12px; color: #dc2626; font-weight: bold;">HIGH RISK</div>
                                        </div>
                                    </div>
                                    <div style="background: #fef2f2; padding: 12px; border-radius: 8px; border-left: 4px solid #dc2626; margin-bottom: 10px;">
                                        <div style="font-family: monospace; font-size: 13px; color: #dc2626; font-weight: bold; word-break: break-all; margin-bottom: 8px;">
                                            ${wallet.address}
                                        </div>
                                        <div style="display: flex; gap: 15px; font-size: 11px; color: #991b1b;">
                                            <div>üìÖ First: ${new Date(wallet.firstSeen).toLocaleDateString()}</div>
                                            <div>üìÖ Last: ${new Date(wallet.lastSeen).toLocaleDateString()}</div>
                                        </div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px;">
                                        <div style="background: #fee2e2; padding: 10px; border-radius: 6px; text-align: center;">
                                            <div style="font-size: 20px; font-weight: bold; color: #dc2626;">${wallet.transactionCount}</div>
                                            <div style="font-size: 10px; color: #991b1b;">Transactions</div>
                                        </div>
                                        <div style="background: #fee2e2; padding: 10px; border-radius: 6px; text-align: center;">
                                            <div style="font-size: 16px; font-weight: bold; color: #dc2626;">${formatWei(wallet.totalVolume)}</div>
                                            <div style="font-size: 10px; color: #991b1b;">Total Volume</div>
                                        </div>
                                        <div style="background: #fee2e2; padding: 10px; border-radius: 6px; text-align: center;">
                                            <div style="font-size: 20px; font-weight: bold; color: #dc2626;">${wallet.chains.length}</div>
                                            <div style="font-size: 10px; color: #991b1b;">Chains</div>
                                        </div>
                                    </div>
                                    <div style="background: #fee2e2; padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                                        <div style="font-size: 11px; color: #991b1b; font-weight: bold; margin-bottom: 8px;">üö® SUSPICIOUS ACTIVITY FLAGS:</div>
                                        <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                            ${wallet.reason.map(r => `<span style="display: inline-block; padding: 6px 12px; background: #dc2626; color: white; border-radius: 6px; font-size: 11px; font-weight: bold;">${r}</span>`).join('')}
                                        </div>
                                    </div>
                                    <div style="text-align: center; padding: 10px; background: #dc2626; color: white; border-radius: 6px; font-size: 12px; font-weight: bold; cursor: pointer;">
                                        üîç CLICK TO TRACE WALLET NETWORK ‚Üí ${wallet.connectedAddresses} Connections
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    if (redFlaggedCountEl) redFlaggedCountEl.textContent = '0';
                    walletsListEl.innerHTML = '<div style="text-align: center; padding: 40px; background: white; border-radius: 8px; border: 2px dashed #e5e7eb;"><p style="color: #6b7280; margin-bottom: 10px; font-size: 16px;">No red-flagged suspicious wallets detected</p><p style="font-size: 12px; color: #9ca3af;">Wallets with risk score >= 70 will appear here</p></div>';
                }
            }

            // Risk Typology Analysis
            const typologyEl = document.getElementById('typologyAnalysis');
            if (typologyEl) {
                if (typologiesData && typologiesData.typologies && Array.isArray(typologiesData.typologies) && typologiesData.typologies.length > 0) {
                    typologyEl.innerHTML = typologiesData.typologies.map(typology => {
                        const isRapidTransactions = typology.type === 'RAPID_TRANSACTIONS';
                        const highlightColor = isRapidTransactions ? '#dc2626' : '#ef4444';
                        const bgColor = isRapidTransactions ? '#fee2e2' : '#fef2f2';
                        
                        return `
                        <div style="background: white; border-radius: 12px; padding: 20px; border-left: 4px solid ${highlightColor}; box-shadow: 0 2px 8px rgba(0,0,0,0.1); ${isRapidTransactions ? 'border: 2px solid #dc2626;' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                <div style="flex: 1;">
                                    <div style="font-weight: bold; font-size: 18px; color: #1e40af; margin-bottom: 5px; display: flex; align-items: center; gap: 8px;">
                                        ${typology.type}
                                        ${isRapidTransactions ? '<span style="background: #dc2626; color: white; padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: bold;">‚ö†Ô∏è CRITICAL</span>' : ''}
                                    </div>
                                    <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">
                                        ${typology.description}
                                    </div>
                                </div>
                                <div style="background: ${bgColor}; padding: 8px 16px; border-radius: 20px; border: 2px solid ${highlightColor};">
                                    <div style="font-size: 14px; font-weight: bold; color: ${highlightColor};">
                                        ${typology.count} Occurrences
                                    </div>
                                    <div style="font-size: 11px; color: ${isRapidTransactions ? '#991b1b' : '#6b7280'}; margin-top: 2px;">
                                        ${typology.walletCount} Wallets
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                                <div style="font-size: 12px; font-weight: bold; color: #6b7280; margin-bottom: 10px;">
                                    Top 10 Wallets with this Pattern:
                                </div>
                                <div style="max-height: 400px; overflow-y: auto;">
                                    ${typology.wallets.length > 0 ? typology.wallets.map((wallet, idx) => {
                                        const rapidInfo = isRapidTransactions && wallet.maxTransactionsInPeriod 
                                            ? `<div style="font-size: 10px; color: #dc2626; font-weight: bold; margin-top: 2px;">‚ö° Max: ${wallet.maxTransactionsInPeriod} TXs in 60s</div>`
                                            : '';
                                        return `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: ${idx === 0 && isRapidTransactions ? '#fee2e2' : '#f9fafb'}; border-radius: 6px; margin-bottom: 8px; ${idx === 0 && isRapidTransactions ? 'border: 1px solid #dc2626;' : ''}">
                                            <div style="flex: 1;">
                                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                                    <span style="font-size: 11px; color: #6b7280; font-weight: bold;">#${idx + 1}</span>
                                                    <span style="font-family: monospace; font-size: 11px; color: #1e40af; font-weight: bold;">
                                                        ${wallet.address.slice(0, 12)}...${wallet.address.slice(-10)}
                                                    </span>
                                                </div>
                                                <div style="font-size: 10px; color: #6b7280; margin-top: 4px;">
                                                    ${wallet.transactionCount} total transactions
                                                </div>
                                                ${rapidInfo}
                                            </div>
                                            <div style="text-align: right;">
                                                <div style="font-size: 14px; font-weight: bold; color: ${wallet.riskScore >= 80 ? '#dc2626' : wallet.riskScore >= 70 ? '#f59e0b' : '#6b7280'};">
                                                    Risk: ${Math.round(wallet.riskScore)}
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                    }).join('') : '<p style="color: #9ca3af; font-size: 11px; text-align: center; padding: 10px;">No wallets found</p>'}
                                </div>
                            </div>
                        </div>
                    `;
                    }).join('');
                } else {
                    typologyEl.innerHTML = '<div style="text-align: center; padding: 40px; background: #f9fafb; border-radius: 8px; grid-column: 1/-1;"><p style="color: #6b7280; margin-bottom: 10px;">No typology data available</p><p style="font-size: 12px; color: #9ca3af;">Typology analysis will appear when suspicious wallets are detected</p></div>';
                }
            }

            // Last updated
            const lastUpdatedEl = document.getElementById('lastUpdated');
            if (lastUpdatedEl) {
                lastUpdatedEl.textContent = new Date().toLocaleString();
                lastUpdatedEl.style.color = '#6b7280';
            }

            // OpenZeppelin Monitor Triggers
            const triggersEl = document.getElementById('monitorTriggers');
            if (triggersEl) {
                if (triggersData && triggersData.triggers && Array.isArray(triggersData.triggers) && triggersData.triggers.length > 0) {
                    triggersEl.innerHTML = triggersData.triggers.map(trigger => `
                        <div style="padding: 15px; background: ${trigger.enabled ? '#f0fdf4' : '#f9fafb'}; border-radius: 8px; border-left: 4px solid ${trigger.enabled ? '#10b981' : '#9ca3af'};">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div>
                                    <div style="font-weight: bold; margin-bottom: 5px;">${trigger.name}</div>
                                    <div style="font-size: 12px; color: #6b7280;">${trigger.description || 'No description'}</div>
                                </div>
                                <span class="status-badge ${trigger.enabled ? 'status-healthy' : 'status-moderate'}">
                                    ${trigger.enabled ? 'ENABLED' : 'DISABLED'}
                                </span>
                            </div>
                            <div style="font-size: 11px; color: #6b7280; margin-top: 10px;">
                                Network: ${trigger.network} | Conditions: ${trigger.conditions.length} | Actions: ${trigger.actions.length}
                            </div>
                        </div>
                    `).join('');
                } else {
                    triggersEl.innerHTML = '<div style="text-align: center; padding: 30px; background: #f9fafb; border-radius: 8px; grid-column: 1/-1;"><p style="color: #6b7280; margin-bottom: 10px;">No triggers configured</p><p style="font-size: 12px; color: #9ca3af;">Triggers are loaded from monitor-triggers.json</p></div>';
                }
            }

            // Monitor Events
            const eventsEl = document.getElementById('monitorEvents');
            if (eventsEl) {
                if (eventsData && eventsData.events && Array.isArray(eventsData.events) && eventsData.events.length > 0) {
                    eventsEl.innerHTML = eventsData.events.map(event => `
                        <div style="padding: 12px; margin-bottom: 10px; background: #f9fafb; border-radius: 5px; border-left: 4px solid #3b82f6;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <strong>${event.triggerName}</strong>
                                <span style="font-size: 11px; color: #6b7280;">${new Date(event.timestamp).toLocaleString()}</span>
                            </div>
                            <div style="font-size: 11px; color: #6b7280; margin-bottom: 5px;">
                                Chain: ${event.transaction.chain} | Hash: ${event.transaction.hash.slice(0, 20)}...
                            </div>
                            <div style="font-size: 11px; color: #6b7280;">
                                Matched: ${event.matchedConditions.join(', ')} | Actions: ${event.actionResults.filter(a => a.success).length}/${event.actionResults.length} succeeded
                            </div>
                        </div>
                    `).join('');
                } else {
                    eventsEl.innerHTML = '<div style="text-align: center; padding: 30px; background: #f9fafb; border-radius: 8px;"><p style="color: #6b7280; margin-bottom: 10px;">No events triggered</p><p style="font-size: 12px; color: #9ca3af;">Events are generated when monitor triggers match transaction conditions</p></div>';
                }
            }

            // Suspicious Patterns
            const patternsList = document.getElementById('patternsList');
            if (patternsList && data && data.suspiciousActivity) {
                const patterns = data.suspiciousActivity.patterns || [];
                if (patterns.length === 0) {
                    patternsList.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">No suspicious patterns detected. Patterns are identified from transaction analysis...</p>';
                } else {
                    patternsList.innerHTML = patterns.map(p => `
                        <div class="pattern-item">
                            <span>${p.type || p.patternType || 'Unknown Pattern'}</span>
                            <strong>${p.count || p.frequency || 0}</strong>
                        </div>
                    `).join('');
                }
            } else if (patternsList) {
                patternsList.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">No suspicious patterns detected. Patterns are identified from transaction analysis...</p>';
            }

            // Enhanced Suspicious Activity
            const enhancedSuspiciousEl = document.getElementById('enhancedSuspiciousActivity');
            if (enhancedSuspiciousEl) {
                if (enhancedSuspiciousData && enhancedSuspiciousData.totalFlagged > 0) {
                    enhancedSuspiciousEl.innerHTML = `
                        <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <div>
                                    <div style="font-size: 24px; font-weight: bold; color: #dc2626; margin-bottom: 5px;">
                                        ${enhancedSuspiciousData.totalFlagged} Flagged Addresses
                                    </div>
                                    <div style="font-size: 14px; color: #6b7280;">
                                        ${enhancedSuspiciousData.highPriority || 0} High Priority
                                    </div>
                                </div>
                            </div>
                            ${enhancedSuspiciousData.flaggedAddresses && enhancedSuspiciousData.flaggedAddresses.length > 0 ? `
                                <div style="max-height: 400px; overflow-y: auto;">
                                    ${enhancedSuspiciousData.flaggedAddresses.slice(0, 20).map(addr => `
                                        <div style="padding: 15px; margin-bottom: 10px; background: #fee2e2; border-left: 4px solid #dc2626; border-radius: 8px;">
                                            <div style="font-family: monospace; font-size: 12px; color: #dc2626; font-weight: bold; margin-bottom: 8px; word-break: break-all;">
                                                ${addr.address}
                                            </div>
                                            <div style="font-size: 11px; color: #991b1b; margin-bottom: 5px;">
                                                Activity Types: ${addr.activityTypes ? addr.activityTypes.join(', ') : 'Unknown'}
                                            </div>
                                            <div style="font-size: 11px; color: #991b1b;">
                                                Risk Score: ${Math.round(addr.riskScore || 0)} | Transactions: ${addr.transactionCount || 0}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : '<p style="color: #6b7280; text-align: center; padding: 20px;">No flagged addresses</p>'}
                        </div>
                    `;
                } else {
                    enhancedSuspiciousEl.innerHTML = '<div style="text-align: center; padding: 30px; background: #f9fafb; border-radius: 8px;"><p style="color: #6b7280; margin-bottom: 10px;">No enhanced suspicious activity detected</p><p style="font-size: 12px; color: #9ca3af;">Tracking flagged addresses with detailed activity information</p></div>';
                }
            }

            // Market Manipulation Alerts (Pump and Dump)
            const marketManipulationEl = document.getElementById('marketManipulationAlerts');
            if (marketManipulationEl) {
                // Debug logging
                console.log('üîç Market Manipulation Data received:', marketManipulationData);
                if (marketManipulationData && marketManipulationData.alerts && Array.isArray(marketManipulationData.alerts) && marketManipulationData.alerts.length > 0) {
                    console.log(`‚úÖ Displaying ${marketManipulationData.alerts.length} market manipulation alerts`);
                    marketManipulationEl.innerHTML = marketManipulationData.alerts.map(alert => {
                        const severityColor = alert.severity === 'critical' ? '#dc2626' : 
                                             alert.severity === 'high' ? '#f59e0b' : 
                                             alert.severity === 'medium' ? '#fbbf24' : '#6b7280';
                        const bgColor = alert.severity === 'critical' ? '#fee2e2' : 
                                       alert.severity === 'high' ? '#fef3c7' : 
                                       alert.severity === 'medium' ? '#fffbeb' : '#f9fafb';
                        const alertIcon = alert.alertType === 'PUMP_DETECTED' ? 'üìà' :
                                         alert.alertType === 'DUMP_DETECTED' ? 'üìâ' :
                                         alert.alertType === 'PUMP_AND_DUMP' ? 'üìàüìâ' :
                                         alert.alertType === 'VOLUME_SPIKE' ? '‚ö°' : 'üö®';
                        
                        return `
                            <div style="padding: 15px; margin-bottom: 10px; background: ${bgColor}; border-left: 4px solid ${severityColor}; border-radius: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: bold; font-size: 14px; color: ${severityColor}; margin-bottom: 5px;">
                                            ${alertIcon} ${alert.alertType?.replace(/_/g, ' ') || 'Market Manipulation Alert'}
                                        </div>
                                        <div style="font-family: monospace; font-size: 11px; color: #92400e; margin-bottom: 5px; word-break: break-all;">
                                            Address: ${alert.address}
                                            ${alert.tokenAddress ? `<br>Token: ${alert.tokenAddress}` : ''}
                                        </div>
                                        <div style="font-size: 12px; color: #92400e; margin-top: 5px;">
                                            ${alert.description || 'Market manipulation pattern detected'}
                                        </div>
                                    </div>
                                    <div style="text-align: right; margin-left: 15px;">
                                        <div style="font-size: 14px; font-weight: bold; color: ${severityColor};">
                                            Risk: ${Math.round(alert.riskScore || 0)}
                                        </div>
                                        <div style="font-size: 11px; color: #6b7280; margin-top: 5px;">
                                            ${new Date(alert.timestamp).toLocaleString()}
                                        </div>
                                        <div style="font-size: 10px; color: #92400e; margin-top: 5px; padding: 2px 6px; background: ${severityColor}; color: white; border-radius: 4px; display: inline-block;">
                                            ${alert.severity?.toUpperCase() || 'MEDIUM'}
                                        </div>
                                    </div>
                                </div>
                                ${alert.priceChange !== undefined ? `
                                    <div style="font-size: 11px; color: #6b7280; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.1);">
                                        Price Change: <strong style="color: ${alert.priceChange >= 0 ? '#10b981' : '#ef4444'}">${alert.priceChange >= 0 ? '+' : ''}${alert.priceChange.toFixed(2)}%</strong>
                                        ${alert.volumeSpike !== undefined ? ` | Volume Spike: <strong>${alert.volumeSpike.toFixed(2)}x</strong>` : ''}
                                        ${alert.pumpProbability !== undefined ? ` | Pump Probability: <strong>${alert.pumpProbability.toFixed(0)}%</strong>` : ''}
                                        ${alert.rsi !== undefined ? ` | RSI: <strong>${alert.rsi.toFixed(2)}</strong>` : ''}
                                    </div>
                                ` : ''}
                                ${alert.relatedAddresses && alert.relatedAddresses.length > 0 ? `
                                    <div style="font-size: 10px; color: #6b7280; margin-top: 5px;">
                                        Related: ${alert.relatedAddresses.slice(0, 3).map(a => a.slice(0, 10) + '...').join(', ')}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }).join('');
                } else {
                    marketManipulationEl.innerHTML = '<div style="text-align: center; padding: 30px; background: #f9fafb; border-radius: 8px;"><p style="color: #6b7280; margin-bottom: 10px;">No market manipulation alerts</p><p style="font-size: 12px; color: #9ca3af;">Monitoring for pump-and-dump schemes, price manipulation, and volume spikes</p></div>';
                }
            }
        }

        // Wallet search and trace function
        async function searchWallet() {
            const input = document.getElementById('walletSearchInput');
            const address = input.value.trim();
            const resultsEl = document.getElementById('walletSearchResults');
            
            if (!address || address.length < 10) {
                resultsEl.innerHTML = '<p style="color: #ef4444; text-align: center; padding: 20px;">Please enter a valid wallet address</p>';
                return;
            }

            resultsEl.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">Searching wallet...</p>';

            try {
                const [profileResponse, relationshipsResponse, traceResponse] = await Promise.all([
                    fetch(`/api/wallets/${address}`),
                    fetch(`/api/wallets/${address}/relationships`),
                    fetch(`/api/wallets/${address}/trace?depth=2`)
                ]);

                const profile = await profileResponse.json().catch(() => null);
                const relationships = await relationshipsResponse.json().catch(() => null);
                const trace = await traceResponse.json().catch(() => null);

                if (!profile || profileResponse.status === 404) {
                    resultsEl.innerHTML = '<p style="color: #ef4444; text-align: center; padding: 20px;">Wallet not found in tracking system</p>';
                    return;
                }

                let html = `
                    <div class="flow-item" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);">
                        <div style="font-weight: bold; font-size: 18px; color: #0ea5e9; margin-bottom: 15px;">
                            üìã Wallet Profile
                        </div>
                        <div style="font-family: monospace; font-size: 12px; color: #1e40af; margin-bottom: 15px; word-break: break-all;">
                            ${profile.address}
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Risk Score</span>
                            <span class="stat-value" style="color: ${profile.riskScore >= 70 ? '#ef4444' : profile.riskScore >= 40 ? '#f59e0b' : '#10b981'};">${Math.round(profile.riskScore)}/100</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Transactions</span>
                            <span class="stat-value">${profile.transactionCount}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Total Volume</span>
                            <span class="stat-value">${formatWei(profile.totalVolume)}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Chains</span>
                            <span class="stat-value">${Array.from(profile.chains).length}</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Connected Wallets</span>
                            <span class="stat-value">${profile.connectedWallets ? Object.keys(profile.connectedWallets).length : 0}</span>
                        </div>
                        ${profile.suspiciousFlags && profile.suspiciousFlags.length > 0 ? `
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(14, 165, 233, 0.2);">
                                <div style="font-size: 12px; font-weight: bold; color: #6b7280; margin-bottom: 8px;">Suspicious Flags:</div>
                                ${profile.suspiciousFlags.map(flag => `<span style="display: inline-block; padding: 4px 8px; background: rgba(239, 68, 68, 0.1); border-radius: 4px; font-size: 10px; margin-right: 5px; margin-top: 5px;">${flag}</span>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;

                if (relationships && relationships.relationships && relationships.relationships.length > 0) {
                    html += `
                        <div style="margin-top: 20px;">
                            <div style="font-weight: bold; font-size: 16px; color: #0ea5e9; margin-bottom: 15px;">
                                üîó Wallet Relationships (${relationships.count})
                            </div>
                            ${relationships.relationships.map(rel => `
                                <div class="flow-item" style="margin-bottom: 10px;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span style="font-family: monospace; font-size: 11px; color: #3b82f6; flex: 1;">
                                            ${rel.from === address ? rel.to.slice(0, 10) + '...' + rel.to.slice(-8) : rel.from.slice(0, 10) + '...' + rel.from.slice(-8)}
                                        </span>
                                        <span class="flow-arrow">‚Üí</span>
                                        <span style="font-size: 11px; color: #6b7280;">${rel.transactionCount} tx</span>
                                        <span style="font-size: 11px; color: #6b7280;">${formatWei(rel.totalValue)}</span>
                                        <span class="chain-badge" style="font-size: 9px;">${Array.from(rel.chains)[0] || 'unknown'}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }

                if (trace && trace.connections && trace.connections.length > 0) {
                    html += `
                        <div style="margin-top: 20px;">
                            <div style="font-weight: bold; font-size: 16px; color: #0ea5e9; margin-bottom: 15px;">
                                üï∏Ô∏è Wallet Network (${trace.connections.length} connections)
                            </div>
                            <div style="background: rgba(255, 255, 255, 0.7); padding: 15px; border-radius: 8px;">
                                ${trace.connections.map(conn => `
                                    <div style="padding: 8px; margin-bottom: 5px; background: rgba(14, 165, 233, 0.05); border-radius: 5px; border-left: 3px solid ${conn.riskScore >= 70 ? '#ef4444' : conn.riskScore >= 40 ? '#f59e0b' : '#10b981'};">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <span style="font-family: monospace; font-size: 11px; color: #1e40af;">
                                                ${conn.address.slice(0, 10)}...${conn.address.slice(-8)}
                                            </span>
                                            <div style="display: flex; gap: 10px; align-items: center;">
                                                <span style="font-size: 10px; color: #6b7280;">Distance: ${conn.distance}</span>
                                                <span style="font-size: 10px; font-weight: bold; color: ${conn.riskScore >= 70 ? '#ef4444' : conn.riskScore >= 40 ? '#f59e0b' : '#10b981'};">
                                                    Risk: ${Math.round(conn.riskScore)}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                resultsEl.innerHTML = html;
            } catch (error) {
                console.error('Wallet search error:', error);
                resultsEl.innerHTML = '<p style="color: #ef4444; text-align: center; padding: 20px;">Error searching wallet: ' + error.message + '</p>';
            }
        }

        // Trace wallet from suspicious list
        async function traceWallet(address) {
            document.getElementById('walletSearchInput').value = address;
            await searchWallet();
            // Scroll to search results
            document.getElementById('walletSearchResults').scrollIntoView({ behavior: 'smooth' });
        }

        // Chart instances
        let chainVolumeChart = null;
        let chainRiskChart = null;

        function updateChainCharts(chainData) {
            // Volume Chart
            const volumeCtx = document.getElementById('chainVolumeChart');
            if (volumeCtx) {
                if (chainVolumeChart) chainVolumeChart.destroy();
                chainVolumeChart = new Chart(volumeCtx, {
                    type: 'bar',
                    data: {
                        labels: chainData.map(c => c.chain.toUpperCase()),
                        datasets: [{
                            label: 'Volume (ETH)',
                            data: chainData.map(c => Number(c.volume) / 1e18),
                            backgroundColor: 'rgba(59, 130, 246, 0.6)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }

            // Risk Chart
            const riskCtx = document.getElementById('chainRiskChart');
            if (riskCtx) {
                if (chainRiskChart) chainRiskChart.destroy();
                chainRiskChart = new Chart(riskCtx, {
                    type: 'line',
                    data: {
                        labels: chainData.map(c => c.chain.toUpperCase()),
                        datasets: [{
                            label: 'Avg Risk Score',
                            data: chainData.map(c => Math.round(c.riskScore || 0)),
                            borderColor: 'rgba(239, 68, 68, 1)',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true, max: 100 }
                        }
                    }
                });
            }
        }

        // Tab switching
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
                tab.style.display = 'none';
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            const selectedTab = document.getElementById(`tab-content-${tabName}`);
            const selectedButton = document.getElementById(`tab-${tabName}`);
            
            if (selectedTab) {
                selectedTab.classList.add('active');
                selectedTab.style.display = 'block';
            }
            
            if (selectedButton) {
                selectedButton.classList.add('active');
            }
            
            // Hide/show sections based on active tab
            const hideSections = tabName === 'financial-statements' || tabName === 'blockchain-monitor';
            document.querySelectorAll('.hide-on-financial-blockchain-tabs').forEach(section => {
                section.style.display = hideSections ? 'none' : 'block';
            });
            
            // Fetch data for the selected tab
            if (tabName === 'crypto-market') {
                fetchMarketData();
            } else if (tabName === 'financial-statements') {
                loadFinancialEntities();
                loadDeFiTrends(); // Load DeFi trends when opening financial statements tab
            } else if (tabName === 'blockchain-monitor') {
                fetchBlockchainData();
                startBlockchainMonitor();
            }
        }
        
        // Blockchain Monitor Functions
        let selectedChain = 'ethereum';
        let blockchainMonitorInterval = null;
        
        function selectChain(chain) {
            selectedChain = chain;
            document.querySelectorAll('.chain-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.toLowerCase().includes(chain.toLowerCase())) {
                    btn.classList.add('active');
                }
            });
            fetchBlockchainData();
        }
        
        async function fetchBlockchainData() {
            try {
                // Fetch market data for current chain
                const marketResponse = await fetch('/api/etherscan/market');
                const marketData = await marketResponse.json();
                
                // Update network stats
                if (marketData.blockNumber) {
                    document.getElementById('currentBlockNumber').textContent = marketData.blockNumber;
                }
                
                if (marketData.gasPrices) {
                    const gasPrice = marketData.gasPrices.proposed || marketData.gasPrices.safe || 0;
                    document.getElementById('gasPrice').textContent = Math.round(gasPrice);
                    document.getElementById('gasPriceChange').textContent = 'Gwei';
                }
                
                // Fetch agent stats for transaction data
                const statsResponse = await fetch('/api/stats');
                const statsData = await statsResponse.json();
                
                if (statsData.stats) {
                    const txCount = statsData.stats.transactionsProcessed || 0;
                    document.getElementById('totalTx24h').textContent = txCount.toLocaleString();
                    
                    // Calculate average transactions per block (assuming ~12s block time)
                    const blocksPerDay = 7200; // 24 hours * 60 minutes * 60 seconds / 12 seconds
                    const txPerBlock = Math.round(txCount / blocksPerDay);
                    document.getElementById('txPerBlock').textContent = txPerBlock;
                    document.getElementById('txPerBlockChange').textContent = `Avg: ${txPerBlock}`;
                }
                
                // Update block time (Ethereum ~12s, others vary)
                const blockTimes = {
                    'ethereum': '12s',
                    'polygon': '2s',
                    'bsc': '3s',
                    'arbitrum': '0.3s',
                    'optimism': '2s',
                    'base': '2s',
                    'avalanche-fuji': '2s'
                };
                document.getElementById('blockTime').textContent = blockTimes[selectedChain] || '12s';
                
                // Update network status
                document.getElementById('networkStatus').textContent = 'üü¢';
                document.getElementById('networkHealthDetails').textContent = `${selectedChain.charAt(0).toUpperCase() + selectedChain.slice(1)} network operational`;
                
                // Fetch recent transactions for blocks visualization
                updateBlocksVisualization(statsData.recentTransactions || []);
                
                // Update multi-chain table
                updateMultiChainTable();
                
                // Update real-time transaction feed
                updateRealtimeTxFeed(statsData.recentTransactions || []);
                
            } catch (error) {
                console.error('Error fetching blockchain data:', error);
            }
        }
        
        function updateBlocksVisualization(transactions) {
            const container = document.getElementById('blocksVisualization');
            
            // Group transactions by approximate block (simulate blocks)
            const blocks = [];
            const blockSize = 150; // Transactions per block (approximate)
            
            for (let i = 0; i < Math.min(20, Math.ceil(transactions.length / blockSize)); i++) {
                const blockStart = i * blockSize;
                const blockTxs = transactions.slice(blockStart, blockStart + blockSize);
                blocks.push({
                    number: (parseInt(document.getElementById('currentBlockNumber').textContent) || 0) - (19 - i),
                    txCount: blockTxs.length,
                    timestamp: blockTxs[0]?.timestamp || Date.now()
                });
            }
            
            if (blocks.length === 0) {
                container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #94a3b8;">No block data available</div>';
                return;
            }
            
            container.innerHTML = blocks.map(block => `
                <div class="block-item">
                    <div class="block-number">#${block.number}</div>
                    <div class="block-tx-count">${block.txCount} TX</div>
                </div>
            `).join('');
        }
        
        function updateMultiChainTable() {
            const chains = ['ethereum', 'polygon', 'bsc', 'arbitrum', 'optimism', 'base', 'avalanche-fuji'];
            const tbody = document.getElementById('multiChainTableBody');
            
            // Fetch stats for all chains
            fetch('/api/stats')
                .then(res => res.json())
                .then(data => {
                    const stats = data.stats || {};
                    const blockNumber = parseInt(document.getElementById('currentBlockNumber').textContent) || 0;
                    
                    tbody.innerHTML = chains.map(chain => {
                        const chainName = chain.charAt(0).toUpperCase() + chain.slice(1);
                        const isActive = chain === selectedChain;
                        const txCount = Math.floor(Math.random() * 1000) + 100; // Simulated
                        const gasPrice = Math.floor(Math.random() * 50) + 10;
                        
                        return `
                            <tr style="${isActive ? 'background: rgba(96, 165, 250, 0.1);' : ''}">
                                <td style="color: #60a5fa; font-weight: ${isActive ? 'bold' : 'normal'};">${chainName}</td>
                                <td>${(blockNumber - Math.floor(Math.random() * 1000)).toLocaleString()}</td>
                                <td>${txCount.toLocaleString()}</td>
                                <td>${gasPrice} Gwei</td>
                                <td><span class="metric-badge badge-success">Active</span></td>
                                <td style="color: #10b981;">üü¢ High</td>
                            </tr>
                        `;
                    }).join('');
                })
                .catch(err => {
                    console.error('Error updating multi-chain table:', err);
                });
        }
        
        function updateRealtimeTxFeed(transactions) {
            const feed = document.getElementById('realtimeTxFeed');
            
            if (!transactions || transactions.length === 0) {
                feed.innerHTML = '<div style="text-align: center; padding: 30px; color: #94a3b8;">Waiting for transactions...</div>';
                return;
            }
            
            const recentTxs = transactions.slice(0, 20).reverse();
            feed.innerHTML = recentTxs.map(tx => {
                const riskClass = tx.riskScore >= 70 ? 'badge-danger' : tx.riskScore >= 40 ? 'badge-warning' : 'badge-success';
                const riskText = tx.riskScore >= 70 ? 'High' : tx.riskScore >= 40 ? 'Medium' : 'Low';
                const timeAgo = Math.floor((Date.now() - (tx.timestamp || Date.now())) / 1000);
                
                return `
                    <div style="padding: 12px; border-bottom: 1px solid rgba(148, 163, 184, 0.1); display: flex; justify-content: space-between; align-items: center;">
                        <div style="flex: 1;">
                            <div style="color: #cbd5e1; font-family: monospace; font-size: 12px; margin-bottom: 5px;">
                                ${tx.hash ? tx.hash.substring(0, 20) + '...' : 'Unknown'}
                            </div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <span style="color: #94a3b8; font-size: 11px;">${tx.chain || 'ethereum'}</span>
                                <span class="metric-badge ${riskClass}">${riskText} Risk</span>
                                <span style="color: #94a3b8; font-size: 11px;">${timeAgo}s ago</span>
                            </div>
                        </div>
                        <div style="color: #60a5fa; font-weight: bold; font-size: 14px;">
                            ${tx.riskScore || 0}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function refreshBlocks() {
            fetchBlockchainData();
        }
        
        function startBlockchainMonitor() {
            // Clear existing interval
            if (blockchainMonitorInterval) {
                clearInterval(blockchainMonitorInterval);
            }
            
            // Fetch data immediately
            fetchBlockchainData();
            
            // Update every 5 seconds
            blockchainMonitorInterval = setInterval(() => {
                if (document.getElementById('tab-content-blockchain-monitor')?.classList.contains('active')) {
                    fetchBlockchainData();
                }
            }, 5000);
        }
        
        // Investigation Tools Functions
        async function investigateAddress() {
            const input = document.getElementById('investigationAddressInput');
            const address = input.value.trim();
            
            if (!address || address.length < 10 || !address.startsWith('0x')) {
                alert('Please enter a valid Ethereum address (0x...)');
                return;
            }
            
            const resultsEl = document.getElementById('investigationResults');
            resultsEl.style.display = 'block';
            resultsEl.innerHTML = '<div style="text-align: center; padding: 30px; color: #94a3b8;"><div style="font-size: 24px; margin-bottom: 10px;">üîç</div>Investigating address with BlockExplorer and Gemini AI...<br><span style="font-size: 11px; color: #64748b;">This may take a few moments</span></div>';
            
            try {
                // Use new investigation endpoint with Gemini AI
                const response = await fetch(`/api/investigation/address/${address}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                displayInvestigationResults(data);
            } catch (error) {
                console.error('Investigation error:', error);
                resultsEl.innerHTML = `<div style="padding: 20px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; color: #ef4444;">
                    <strong>‚ùå Error:</strong> ${error.message || 'Failed to investigate address'}<br>
                    <span style="font-size: 11px; color: #dc2626;">Make sure the server is running</span>
                </div>`;
            }
        }
        
        function displayInvestigationResults(data) {
            const resultsEl = document.getElementById('investigationResults');
            
            const aiAnalysis = data.aiInvestigation || {};
            const riskScore = aiAnalysis.riskScore || data.analysis?.riskScore || 0;
            const riskLevel = riskScore >= 70 ? 'HIGH' : riskScore >= 40 ? 'MEDIUM' : 'LOW';
            const riskColor = riskScore >= 70 ? '#ef4444' : riskScore >= 40 ? '#f59e0b' : '#10b981';
            
            resultsEl.innerHTML = `
                <div style="background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; padding: 20px;">
                    <h3 style="color: #60a5fa; margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                        üìä Investigation Report ${aiAnalysis.summary ? 'ü§ñ AI-Powered' : ''}
                    </h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 6px; padding: 15px;">
                            <div style="color: #94a3b8; font-size: 11px; margin-bottom: 5px;">ADDRESS</div>
                            <div style="color: #cbd5e1; font-family: monospace; font-size: 12px; word-break: break-all;">${data.address || 'N/A'}</div>
                        </div>
                        <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 6px; padding: 15px;">
                            <div style="color: #94a3b8; font-size: 11px; margin-bottom: 5px;">BALANCE</div>
                            <div style="color: #60a5fa; font-size: 18px; font-weight: bold;">${parseFloat(data.balance || 0).toFixed(4)} ETH</div>
                        </div>
                        <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 6px; padding: 15px;">
                            <div style="color: #94a3b8; font-size: 11px; margin-bottom: 5px;">RISK SCORE</div>
                            <div style="color: ${riskColor}; font-size: 24px; font-weight: bold;">${riskScore}</div>
                            <div style="color: ${riskColor}; font-size: 11px; margin-top: 5px;">${riskLevel} RISK</div>
                        </div>
                        <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 6px; padding: 15px;">
                            <div style="color: #94a3b8; font-size: 11px; margin-bottom: 5px;">TRANSACTIONS</div>
                            <div style="color: #cbd5e1; font-size: 18px; font-weight: bold;">${data.transactionCount || 0}</div>
                        </div>
                    </div>
                    
                    ${aiAnalysis.summary ? `
                    <div style="background: linear-gradient(135deg, rgba(147, 51, 234, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%); border: 1px solid rgba(147, 51, 234, 0.3); border-radius: 6px; padding: 15px; margin-bottom: 15px;">
                        <div style="color: #9333ea; font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
                            ü§ñ Gemini AI Analysis
                        </div>
                        <div style="color: #cbd5e1; font-size: 13px; line-height: 1.6; margin-bottom: 10px;">
                            ${aiAnalysis.summary || 'No AI analysis available'}
                        </div>
                        ${aiAnalysis.category ? `<div style="color: #94a3b8; font-size: 11px; margin-top: 8px;"><strong>Category:</strong> ${aiAnalysis.category}</div>` : ''}
                        ${aiAnalysis.redFlags && aiAnalysis.redFlags.length > 0 ? `
                            <div style="margin-top: 10px;">
                                <div style="color: #ef4444; font-size: 11px; font-weight: bold; margin-bottom: 5px;">üö© Red Flags:</div>
                                <ul style="color: #cbd5e1; font-size: 11px; margin-left: 20px;">
                                    ${aiAnalysis.redFlags.map(flag => `<li>${flag}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        ${aiAnalysis.recommendations && aiAnalysis.recommendations.length > 0 ? `
                            <div style="margin-top: 10px;">
                                <div style="color: #60a5fa; font-size: 11px; font-weight: bold; margin-bottom: 5px;">üí° Recommendations:</div>
                                <ul style="color: #cbd5e1; font-size: 11px; margin-left: 20px;">
                                    ${aiAnalysis.recommendations.map(rec => `<li>${rec}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                    ` : ''}
                    
                    ${data.analysis?.suspicious ? `
                    <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 6px; padding: 15px; margin-bottom: 15px;">
                        <div style="color: #ef4444; font-weight: bold; margin-bottom: 10px;">‚ö†Ô∏è SUSPICIOUS ACTIVITY DETECTED</div>
                        <div style="color: #cbd5e1; font-size: 12px;">
                            <strong>Flags:</strong> ${data.analysis.flags?.join(', ') || 'None'}<br>
                            <strong>Total Volume:</strong> ${(parseFloat(data.analysis.totalVolume || 0) / 1e18).toFixed(4)} ETH<br>
                            <strong>Rapid Transactions:</strong> ${data.analysis.rapidTransactions || 0}
                        </div>
                    </div>
                    ` : ''}
                    
                    <div style="margin-top: 15px;">
                        <div style="color: #60a5fa; font-weight: bold; margin-bottom: 10px;">Recent Transactions (Top 10)</div>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${(data.transactions || []).slice(0, 10).map(tx => `
                                <div style="padding: 10px; margin-bottom: 8px; background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(148, 163, 184, 0.1); border-radius: 4px;">
                                    <div style="color: #cbd5e1; font-family: monospace; font-size: 11px; margin-bottom: 5px;">
                                        <a href="https://etherscan.io/tx/${tx.hash}" target="_blank" style="color: #60a5fa; text-decoration: none;">
                                            ${tx.hash}
                                        </a>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; font-size: 11px; color: #94a3b8;">
                                        <span>From: ${tx.from?.substring(0, 10)}...${tx.from?.substring(tx.from.length - 8)}</span>
                                        <span>${(parseFloat(tx.value || 0) / 1e18).toFixed(6)} ETH</span>
                                    </div>
                                </div>
                            `).join('') || '<div style="color: #94a3b8; text-align: center; padding: 20px;">No transactions found</div>'}
                        </div>
                    </div>
                </div>
            `;
        }
        
        async function traceTransaction() {
            const input = document.getElementById('investigationAddressInput');
            const address = input.value.trim();
            
            if (!address) {
                alert('Please enter an address first');
                return;
            }
            
            try {
                const response = await fetch(`/api/wallets/trace/${address}?depth=3`);
                const data = await response.json();
                
                const resultsEl = document.getElementById('investigationResults');
                resultsEl.style.display = 'block';
                resultsEl.innerHTML = `
                    <div style="background: rgba(15, 23, 42, 0.8); border: 1px solid rgba(96, 165, 250, 0.3); border-radius: 8px; padding: 20px;">
                        <h3 style="color: #60a5fa; margin-bottom: 15px;">üîó Transaction Flow Trace</h3>
                        <div style="color: #cbd5e1; font-size: 13px; margin-bottom: 15px;">
                            <strong>Address:</strong> <span style="font-family: monospace;">${address}</span>
                        </div>
                        <div style="color: #94a3b8; font-size: 12px;">
                            Flow tracing analysis would be displayed here. This feature traces transaction relationships and fund flows.
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Trace error:', error);
            }
        }
        
        function runTaintAnalysis() {
            const input = document.getElementById('investigationAddressInput');
            const address = input.value.trim();
            
            if (!address) {
                alert('Please enter an address to analyze');
                return;
            }
            
            alert('Taint Analysis: This feature traces fund contamination paths from source addresses. Analysis would show how funds flow through the network and identify potential connections to suspicious sources.');
        }
        
        function runAddressClustering() {
            const input = document.getElementById('investigationAddressInput');
            const address = input.value.trim();
            
            if (!address) {
                alert('Please enter an address to cluster');
                return;
            }
            
            alert('Address Clustering: This feature identifies related addresses that likely belong to the same entity or wallet cluster. It uses heuristics like shared inputs, change addresses, and transaction patterns.');
        }
        
        function visualizeFlow() {
            const input = document.getElementById('investigationAddressInput');
            const address = input.value.trim();
            
            if (!address) {
                alert('Please enter an address to visualize');
                return;
            }
            
            alert('Flow Visualization: This feature generates interactive graph visualizations of transaction flows, showing relationships between addresses and the movement of funds. Visual graphs help identify patterns and connections.');
        }
        
        function runCrossChainAnalysis() {
            const input = document.getElementById('investigationAddressInput');
            const address = input.value.trim();
            
            if (!address) {
                alert('Please enter an address to analyze across chains');
                return;
            }
            
            alert('Cross-Chain Analysis: This feature tracks the same address or related addresses across multiple blockchain networks (Ethereum, Polygon, BSC, Arbitrum, etc.) to identify cross-chain fund movements and bridge transactions.');
        }
        
        function detectMEV() {
            const input = document.getElementById('investigationAddressInput');
            const address = input.value.trim();
            
            if (!address) {
                alert('Please enter an address to scan for MEV');
                return;
            }
            
            alert('MEV Detection: This feature identifies Maximal Extractable Value (MEV) activities including front-running, back-running, sandwich attacks, and arbitrage opportunities. It analyzes transaction ordering and gas prices.');
        }
        
        function generateRiskProfile() {
            const input = document.getElementById('investigationAddressInput');
            const address = input.value.trim();
            
            if (!address) {
                alert('Please enter an address to profile');
                return;
            }
            
            alert('Risk Profiling: This feature generates a comprehensive risk assessment profile including transaction patterns, volume analysis, time-based behavior, and association with known risky addresses or entities.');
        }
        
        // Allow Enter key to trigger investigation
        document.addEventListener('DOMContentLoaded', () => {
            const investigationInput = document.getElementById('investigationAddressInput');
            if (investigationInput) {
                investigationInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        investigateAddress();
                    }
                });
            }
        });

        // Load DeFi Trends Research
        async function loadDeFiTrends() {
            const trendsContentEl = document.getElementById('defiTrendsContent');
            if (!trendsContentEl) return;

            // Show loading state
            trendsContentEl.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #6b7280;">
                    <div style="font-size: 48px; margin-bottom: 15px;">üîç</div>
                    <p style="margin-bottom: 10px; font-weight: bold;">Researching DeFi Trends...</p>
                    <p style="font-size: 12px; color: #9ca3af;">Generating comprehensive market analysis with horizon scanning capabilities</p>
                    <div style="margin-top: 20px;">
                        <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #9333ea; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    </div>
                </div>
            `;

            try {
                const response = await fetch('/api/defi/trends');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                // Build the trends display
                let html = '';

                // Summary Section
                if (data.summary) {
                    html += `
                        <div style="background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); border-left: 4px solid #9333ea; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                            <h3 style="color: #9333ea; margin-bottom: 10px; font-size: 18px;">üìä Market Overview</h3>
                            <p style="color: #4b5563; line-height: 1.6; font-size: 14px;">${data.summary}</p>
                            ${data.marketSize ? `<p style="color: #9333ea; font-weight: bold; margin-top: 10px; font-size: 13px;">${data.marketSize}</p>` : ''}
                        </div>
                    `;
                }

                // Trends Section
                if (data.trends && data.trends.length > 0) {
                    html += `
                        <div style="margin-bottom: 25px;">
                            <h3 style="color: #9333ea; margin-bottom: 15px; font-size: 18px; border-bottom: 2px solid #e9d5ff; padding-bottom: 10px;">üöÄ Key DeFi Trends</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
                    `;
                    data.trends.forEach(trend => {
                        html += `
                            <div style="background: #faf5ff; border: 2px solid #e9d5ff; border-radius: 10px; padding: 20px;">
                                <h4 style="color: #7c3aed; margin-bottom: 10px; font-size: 16px; border-bottom: 1px solid #e9d5ff; padding-bottom: 8px;">${trend.category}</h4>
                                <p style="color: #4b5563; font-size: 13px; line-height: 1.6; margin-bottom: 15px;">${trend.description || 'No description available'}</p>
                                ${trend.keyCompanies && trend.keyCompanies.length > 0 ? `
                                    <div style="margin-bottom: 12px;">
                                        <div style="color: #9333ea; font-size: 12px; font-weight: bold; margin-bottom: 8px;">üîë Key Companies/Protocols:</div>
                                        <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                                            ${trend.keyCompanies.map(company => `
                                                <span style="background: #e9d5ff; color: #7c3aed; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 500;">${company}</span>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                                ${trend.marketMetrics ? `
                                    <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 12px; border-left: 3px solid #9333ea;">
                                        <div style="color: #9333ea; font-size: 11px; font-weight: bold; margin-bottom: 5px;">üìä Market Metrics:</div>
                                        <div style="color: #1f2937; font-size: 12px; line-height: 1.5; white-space: pre-line;">${trend.marketMetrics}</div>
                                    </div>
                                ` : ''}
                                <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-bottom: 12px;">
                                    ${trend.growthRate ? `
                                        <div style="background: #d1fae5; color: #065f46; padding: 6px 12px; border-radius: 6px; font-size: 11px; font-weight: 600;">üìà ${trend.growthRate}</div>
                                    ` : ''}
                                    ${trend.marketTimeline ? `
                                        <div style="background: #dbeafe; color: #1e40af; padding: 6px 12px; border-radius: 6px; font-size: 11px; font-weight: 600;">‚è±Ô∏è ${trend.marketTimeline}</div>
                                    ` : ''}
                                    ${trend.regulatoryStatus ? `
                                        <div style="background: #fef3c7; color: #92400e; padding: 6px 12px; border-radius: 6px; font-size: 11px; font-weight: 600;">‚öñÔ∏è ${trend.regulatoryStatus}</div>
                                    ` : ''}
                                </div>
                                ${trend.riskFactors && trend.riskFactors.length > 0 ? `
                                    <div style="background: #fef2f2; padding: 10px; border-radius: 6px; margin-top: 10px; border-left: 3px solid #ef4444;">
                                        <div style="color: #991b1b; font-size: 11px; font-weight: bold; margin-bottom: 5px;">‚ö†Ô∏è Risk Factors:</div>
                                        <ul style="color: #7f1d1d; font-size: 11px; line-height: 1.6; margin-left: 18px; margin-top: 5px;">
                                            ${trend.riskFactors.map(risk => `<li>${risk}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                                ${trend.opportunities && trend.opportunities.length > 0 ? `
                                    <div style="background: #f0fdf4; padding: 10px; border-radius: 6px; margin-top: 10px; border-left: 3px solid #10b981;">
                                        <div style="color: #065f46; font-size: 11px; font-weight: bold; margin-bottom: 5px;">üí° Opportunities:</div>
                                        <ul style="color: #047857; font-size: 11px; line-height: 1.6; margin-left: 18px; margin-top: 5px;">
                                            ${trend.opportunities.map(opp => `<li>${opp}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });
                    html += `</div></div>`;
                }

                // Top Protocols Section
                if (data.topProtocols && data.topProtocols.length > 0) {
                    html += `
                        <div style="margin-bottom: 25px;">
                            <h3 style="color: #9333ea; margin-bottom: 15px; font-size: 18px; border-bottom: 2px solid #e9d5ff; padding-bottom: 10px;">üèÜ Top DeFi Protocols</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                    `;
                    data.topProtocols.forEach(protocol => {
                        html += `
                            <div style="background: white; border: 1px solid #e9d5ff; border-radius: 8px; padding: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                    <h4 style="color: #7c3aed; font-size: 15px; margin: 0; font-weight: bold;">${protocol.name}</h4>
                                    <span style="background: #f3e8ff; color: #9333ea; padding: 3px 8px; border-radius: 4px; font-size: 10px; font-weight: 500;">${protocol.category || 'DeFi'}</span>
                                </div>
                                <p style="color: #6b7280; font-size: 12px; line-height: 1.5; margin-bottom: 10px;">${protocol.description || 'No description'}</p>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    ${protocol.tvl ? `
                                        <div style="background: #f3e8ff; color: #9333ea; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;">üí∞ TVL: ${protocol.tvl}</div>
                                    ` : ''}
                                    ${protocol.growth ? `
                                        <div style="background: #d1fae5; color: #065f46; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;">üìà ${protocol.growth}</div>
                                    ` : ''}
                                    ${protocol.users ? `
                                        <div style="background: #dbeafe; color: #1e40af; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;">üë• ${protocol.users}</div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    });
                    html += `</div></div>`;
                }

                // Institutional Adoption Section
                if (data.institutionalAdoption) {
                    html += `
                        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-left: 4px solid #f59e0b; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                            <h3 style="color: #92400e; margin-bottom: 15px; font-size: 18px; font-weight: bold;">üè¶ Institutional Adoption</h3>
                            <p style="color: #78350f; line-height: 1.6; font-size: 14px; margin-bottom: 15px;">${data.institutionalAdoption.summary || 'No summary available'}</p>
                            ${data.institutionalAdoption.keyPlayers && data.institutionalAdoption.keyPlayers.length > 0 ? `
                                <div style="margin-bottom: 15px;">
                                    <div style="color: #92400e; font-size: 13px; font-weight: bold; margin-bottom: 8px;">üîë Key Players:</div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                        ${data.institutionalAdoption.keyPlayers.map(player => `
                                            <span style="background: #fef3c7; color: #92400e; padding: 5px 12px; border-radius: 12px; font-size: 11px; font-weight: 600; border: 1px solid #fbbf24;">${player}</span>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            ${data.institutionalAdoption.products && data.institutionalAdoption.products.length > 0 ? `
                                <div style="margin-bottom: 15px;">
                                    <div style="color: #92400e; font-size: 13px; font-weight: bold; margin-bottom: 8px;">üì¶ Products & Initiatives:</div>
                                    <ul style="color: #78350f; font-size: 12px; margin-left: 20px; line-height: 1.8;">
                                        ${data.institutionalAdoption.products.map(product => `<li style="margin-bottom: 5px;">${product}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            ${data.institutionalAdoption.investmentTrends && data.institutionalAdoption.investmentTrends.length > 0 ? `
                                <div style="background: white; padding: 15px; border-radius: 6px; margin-top: 15px; border: 1px solid #fbbf24;">
                                    <div style="color: #92400e; font-size: 13px; font-weight: bold; margin-bottom: 8px;">üìä Investment Trends:</div>
                                    <ul style="color: #78350f; font-size: 12px; margin-left: 20px; line-height: 1.8;">
                                        ${data.institutionalAdoption.investmentTrends.map(trend => `<li style="margin-bottom: 5px;">${trend}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }

                // Regulatory Developments Section
                if (data.regulatoryDevelopments) {
                    html += `
                        <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-left: 4px solid #3b82f6; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                            <h3 style="color: #1e40af; margin-bottom: 15px; font-size: 18px;">‚öñÔ∏è Regulatory Developments</h3>
                            <p style="color: #1e3a8a; line-height: 1.6; font-size: 14px; margin-bottom: 15px;">${data.regulatoryDevelopments.summary || 'No summary available'}</p>
                            ${data.regulatoryDevelopments.keyChanges && data.regulatoryDevelopments.keyChanges.length > 0 ? `
                                <div style="margin-bottom: 10px;">
                                    <div style="color: #1e40af; font-size: 12px; font-weight: bold; margin-bottom: 5px;">Key Changes:</div>
                                    <ul style="color: #1e3a8a; font-size: 12px; margin-left: 20px; line-height: 1.8;">
                                        ${data.regulatoryDevelopments.keyChanges.map(change => `<li>${change}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            ${data.regulatoryDevelopments.impact ? `
                                <div style="background: white; padding: 12px; border-radius: 6px; margin-top: 10px;">
                                    <div style="color: #1e40af; font-size: 12px; font-weight: bold; margin-bottom: 5px;">Impact:</div>
                                    <div style="color: #1e3a8a; font-size: 13px; line-height: 1.6;">${data.regulatoryDevelopments.impact}</div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }

                // Future Outlook Section
                if (data.futureOutlook) {
                    html += `
                        <div style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); border-left: 4px solid #10b981; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
                            <h3 style="color: #065f46; margin-bottom: 10px; font-size: 18px;">üîÆ Future Outlook</h3>
                            <p style="color: #047857; line-height: 1.6; font-size: 14px;">${data.futureOutlook}</p>
                        </div>
                    `;
                }

                // Risks & Opportunities
                if ((data.risks && data.risks.length > 0) || (data.opportunities && data.opportunities.length > 0)) {
                    html += `
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    `;
                    if (data.risks && data.risks.length > 0) {
                        html += `
                            <div style="background: #fef2f2; border-left: 4px solid #ef4444; padding: 20px; border-radius: 8px;">
                                <h3 style="color: #991b1b; margin-bottom: 15px; font-size: 16px;">‚ö†Ô∏è Key Risks</h3>
                                <ul style="color: #7f1d1d; font-size: 13px; line-height: 1.8; margin-left: 20px;">
                                    ${data.risks.map(risk => `<li>${risk}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    if (data.opportunities && data.opportunities.length > 0) {
                        html += `
                            <div style="background: #f0fdf4; border-left: 4px solid #10b981; padding: 20px; border-radius: 8px;">
                                <h3 style="color: #065f46; margin-bottom: 15px; font-size: 16px;">üí° Opportunities</h3>
                                <ul style="color: #047857; font-size: 13px; line-height: 1.8; margin-left: 20px;">
                                    ${data.opportunities.map(opp => `<li>${opp}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                    }
                    html += `</div>`;
                }

                // Horizon Scanning Section
                if (data.horizonScanning) {
                    const hs = data.horizonScanning;
                    
                    // Emerging Trends
                    if (hs.emergingTrends && hs.emergingTrends.length > 0) {
                        html += `
                            <div style="margin-bottom: 30px; margin-top: 30px;">
                                <h3 style="color: #9333ea; margin-bottom: 20px; font-size: 20px; border-bottom: 3px solid #9333ea; padding-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                                    üîÆ Horizon Scanning: Emerging Trends
                                </h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
                        `;
                        hs.emergingTrends.forEach(et => {
                            html += `
                                <div style="background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); border: 2px solid #9333ea; border-radius: 10px; padding: 20px;">
                                    <h4 style="color: #7c3aed; margin-bottom: 10px; font-size: 16px; font-weight: bold;">${et.trend}</h4>
                                    <p style="color: #4b5563; font-size: 13px; line-height: 1.6; margin-bottom: 15px;">${et.description}</p>
                                    <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 12px;">
                                        ${et.timeframe ? `<span style="background: #dbeafe; color: #1e40af; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;">‚è±Ô∏è ${et.timeframe}</span>` : ''}
                                        ${et.marketPotential ? `<span style="background: #d1fae5; color: #065f46; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;">üí∞ ${et.marketPotential}</span>` : ''}
                                        ${et.impact ? `<span style="background: #fef3c7; color: #92400e; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;">üìà ${et.impact}</span>` : ''}
                                    </div>
                                    ${et.keyPlayers && et.keyPlayers.length > 0 ? `
                                        <div style="margin-top: 12px;">
                                            <div style="color: #9333ea; font-size: 11px; font-weight: bold; margin-bottom: 5px;">Key Players:</div>
                                            <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                                                ${et.keyPlayers.map(player => `
                                                    <span style="background: #e9d5ff; color: #7c3aed; padding: 3px 8px; border-radius: 8px; font-size: 10px;">${player}</span>
                                                `).join('')}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        });
                        html += `</div></div>`;
                    }
                    
                    // Technology Breakthroughs
                    if (hs.technologyBreakthroughs && hs.technologyBreakthroughs.length > 0) {
                        html += `
                            <div style="margin-bottom: 30px;">
                                <h3 style="color: #9333ea; margin-bottom: 20px; font-size: 20px; border-bottom: 3px solid #9333ea; padding-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                                    ‚ö° Technology Breakthroughs
                                </h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 15px;">
                        `;
                        hs.technologyBreakthroughs.forEach(tb => {
                            html += `
                                <div style="background: white; border: 2px solid #e9d5ff; border-radius: 8px; padding: 18px;">
                                    <h4 style="color: #7c3aed; margin-bottom: 8px; font-size: 15px; font-weight: bold;">${tb.technology}</h4>
                                    <p style="color: #4b5563; font-size: 12px; line-height: 1.5; margin-bottom: 10px;">${tb.description}</p>
                                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;">
                                        ${tb.impact ? `<span style="background: #d1fae5; color: #065f46; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 600;">üéØ ${tb.impact}</span>` : ''}
                                        ${tb.adoptionTimeline ? `<span style="background: #dbeafe; color: #1e40af; padding: 4px 8px; border-radius: 6px; font-size: 10px; font-weight: 600;">üìÖ ${tb.adoptionTimeline}</span>` : ''}
                                    </div>
                                </div>
                            `;
                        });
                        html += `</div></div>`;
                    }
                    
                    // Market Signals
                    if (hs.marketSignals && hs.marketSignals.length > 0) {
                        html += `
                            <div style="margin-bottom: 30px;">
                                <h3 style="color: #9333ea; margin-bottom: 20px; font-size: 20px; border-bottom: 3px solid #9333ea; padding-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                                    üì° Market Signals & Indicators
                                </h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 15px;">
                        `;
                        hs.marketSignals.forEach(ms => {
                            html += `
                                <div style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-left: 4px solid #3b82f6; border-radius: 8px; padding: 18px;">
                                    <h4 style="color: #1e40af; margin-bottom: 8px; font-size: 15px; font-weight: bold;">${ms.signal}</h4>
                                    <p style="color: #1e3a8a; font-size: 12px; line-height: 1.5; margin-bottom: 10px;">${ms.description}</p>
                                    <div style="background: white; padding: 10px; border-radius: 6px; margin-top: 10px;">
                                        <div style="color: #1e40af; font-size: 11px; font-weight: bold; margin-bottom: 5px;">üí° Implication:</div>
                                        <div style="color: #4b5563; font-size: 12px; line-height: 1.4;">${ms.implication}</div>
                                        ${ms.timeframe ? `<div style="color: #6b7280; font-size: 10px; margin-top: 8px; font-style: italic;">Timeline: ${ms.timeframe}</div>` : ''}
                                    </div>
                                </div>
                            `;
                        });
                        html += `</div></div>`;
                    }
                    
                    // Risk Horizon
                    if (hs.riskHorizon && hs.riskHorizon.length > 0) {
                        html += `
                            <div style="margin-bottom: 30px;">
                                <h3 style="color: #dc2626; margin-bottom: 20px; font-size: 20px; border-bottom: 3px solid #dc2626; padding-bottom: 10px; display: flex; align-items: center; gap: 10px;">
                                    ‚ö†Ô∏è Risk Horizon Assessment
                                </h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 15px;">
                        `;
                        hs.riskHorizon.forEach(rh => {
                            const probColor = rh.probability === "High" ? "#dc2626" : rh.probability === "Medium" ? "#f59e0b" : "#10b981";
                            const impactColor = rh.impact === "Critical" || rh.impact === "High" ? "#dc2626" : rh.impact === "Medium" ? "#f59e0b" : "#10b981";
                            html += `
                                <div style="background: #fef2f2; border: 2px solid #fee2e2; border-radius: 8px; padding: 18px;">
                                    <h4 style="color: #991b1b; margin-bottom: 8px; font-size: 15px; font-weight: bold;">${rh.risk}</h4>
                                    <p style="color: #7f1d1d; font-size: 12px; line-height: 1.5; margin-bottom: 12px;">${rh.description}</p>
                                    <div style="display: flex; gap: 10px; margin-bottom: 12px; flex-wrap: wrap;">
                                        ${rh.probability ? `<span style="background: ${probColor}20; color: ${probColor}; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; border: 1px solid ${probColor};">Probability: ${rh.probability}</span>` : ''}
                                        ${rh.impact ? `<span style="background: ${impactColor}20; color: ${impactColor}; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; border: 1px solid ${impactColor};">Impact: ${rh.impact}</span>` : ''}
                                    </div>
                                    ${rh.mitigation ? `
                                        <div style="background: white; padding: 10px; border-radius: 6px; border-left: 3px solid #10b981;">
                                            <div style="color: #065f46; font-size: 11px; font-weight: bold; margin-bottom: 5px;">üõ°Ô∏è Mitigation Strategies:</div>
                                            <div style="color: #047857; font-size: 11px; line-height: 1.4;">${rh.mitigation}</div>
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        });
                        html += `</div></div>`;
                    }
                }

                // Timestamp
                html += `
                    <div style="text-align: center; padding: 15px; background: #f9fafb; border-radius: 6px; margin-top: 20px;">
                        <div style="color: #6b7280; font-size: 11px;">
                            Last updated: ${new Date(data.timestamp || Date.now()).toLocaleString()} | 
                            Source: ${data.source || 'Comprehensive Research'}
                            ${data.researchDepth ? ` | ${data.researchDepth}` : ''}
                        </div>
                    </div>
                `;

                trendsContentEl.innerHTML = html;
            } catch (error) {
                console.error('Error loading DeFi trends:', error);
                trendsContentEl.innerHTML = `
                    <div style="text-align: center; padding: 40px; background: #fee2e2; border-radius: 8px;">
                        <div style="font-size: 48px; margin-bottom: 15px;">‚ùå</div>
                        <p style="color: #dc2626; margin-bottom: 10px; font-weight: bold;">Error Loading DeFi Trends</p>
                        <p style="font-size: 12px; color: #991b1b; margin-bottom: 15px;">${error.message || 'Failed to fetch DeFi trends data'}</p>
                        <button onclick="loadDeFiTrends()" style="padding: 8px 16px; background: #dc2626; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                            üîÑ Retry
                        </button>
                    </div>
                `;
            }
        }

        // Load Crypto News
        async function loadCryptoNews() {
            const newsContentEl = document.getElementById('cryptoNewsContent');
            if (!newsContentEl) return;

            // Show loading state
            newsContentEl.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #6b7280;">
                    <div style="font-size: 48px; margin-bottom: 15px;">üì∞</div>
                    <p style="margin-bottom: 10px; font-weight: bold;">Loading Latest Crypto News...</p>
                    <p style="font-size: 12px; color: #9ca3af;">Fetching news from trusted sources</p>
                    <div style="margin-top: 20px;">
                        <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #10b981; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    </div>
                </div>
            `;

            try {
                const response = await fetch('/api/crypto/news?limit=10');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                if (!data.news || data.news.length === 0) {
                    newsContentEl.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #6b7280;">
                            <div style="font-size: 48px; margin-bottom: 15px;">üì∞</div>
                            <p style="margin-bottom: 10px; font-weight: bold;">No News Available</p>
                            <p style="font-size: 12px; color: #9ca3af;">Try refreshing in a moment</p>
                        </div>
                    `;
                    return;
                }

                // Build the news display
                let html = `
                    <div style="display: grid; gap: 20px;">
                `;

                data.news.forEach((article, index) => {
                    const publishedDate = new Date(article.publishedAt);
                    const timeAgo = getTimeAgo(publishedDate);
                    
                    html += `
                        <div style="background: white; border: 1px solid #e5e7eb; border-radius: 10px; padding: 20px; transition: all 0.3s; hover:shadow-lg;">
                            <div style="display: flex; gap: 15px;">
                                ${article.image ? `
                                    <div style="flex-shrink: 0;">
                                        <img src="${article.image}" alt="${article.title}" 
                                             style="width: 120px; height: 120px; object-fit: cover; border-radius: 8px; border: 1px solid #e5e7eb;" 
                                             onerror="this.style.display='none'">
                                    </div>
                                ` : ''}
                                <div style="flex: 1;">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                        <h3 style="color: #111827; font-size: 18px; font-weight: bold; margin: 0; line-height: 1.4;">
                                            <a href="${article.url}" target="_blank" rel="noopener noreferrer" 
                                               style="color: #10b981; text-decoration: none; hover:underline;">
                                                ${article.title}
                                            </a>
                                        </h3>
                                        <span style="background: #d1fae5; color: #065f46; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; white-space: nowrap; margin-left: 10px;">
                                            ${article.source}
                                        </span>
                                    </div>
                                    ${article.description ? `
                                        <p style="color: #4b5563; font-size: 14px; line-height: 1.6; margin-bottom: 12px;">
                                            ${article.description.length > 200 ? article.description.substring(0, 200) + '...' : article.description}
                                        </p>
                                    ` : ''}
                                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                                        <div style="display: flex; gap: 15px; align-items: center;">
                                            <span style="color: #6b7280; font-size: 12px;">
                                                üïí ${timeAgo}
                                            </span>
                                            ${article.tags && article.tags.length > 0 ? `
                                                <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                                    ${article.tags.slice(0, 3).map(tag => `
                                                        <span style="background: #f3f4f6; color: #4b5563; padding: 3px 8px; border-radius: 6px; font-size: 10px;">
                                                            ${tag}
                                                        </span>
                                                    `).join('')}
                                                </div>
                                            ` : ''}
                                        </div>
                                        <a href="${article.url}" target="_blank" rel="noopener noreferrer" 
                                           style="color: #10b981; text-decoration: none; font-weight: 600; font-size: 13px; hover:underline;">
                                            Read More ‚Üí
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `</div>`;

                // Add auto-refresh info
                html += `
                    <div style="margin-top: 20px; padding: 15px; background: #f0fdf4; border-radius: 8px; border-left: 4px solid #10b981;">
                        <div style="color: #065f46; font-size: 12px; display: flex; align-items: center; gap: 8px;">
                            <span>üîÑ</span>
                            <span>News updates automatically every 5 minutes. Last updated: ${new Date().toLocaleString()}</span>
                        </div>
                    </div>
                `;

                newsContentEl.innerHTML = html;
            } catch (error) {
                console.error('Error loading crypto news:', error);
                newsContentEl.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <div style="font-size: 48px; margin-bottom: 15px;">‚ö†Ô∏è</div>
                        <p style="margin-bottom: 10px; font-weight: bold;">Error Loading News</p>
                        <p style="font-size: 12px; color: #9ca3af;">${error.message}</p>
                        <button onclick="loadCryptoNews()" style="margin-top: 15px; padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                            Try Again
                        </button>
                    </div>
                `;
            }
        }

        // Helper function to get time ago
        function getTimeAgo(date) {
            const now = new Date();
            const diff = Math.floor((now - date) / 1000); // difference in seconds
            
            if (diff < 60) return 'Just now';
            if (diff < 3600) return `${Math.floor(diff / 60)} minutes ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)} hours ago`;
            if (diff < 604800) return `${Math.floor(diff / 86400)} days ago`;
            return date.toLocaleDateString();
        }

        // Load DABA entities for dropdown
        async function loadFinancialEntities() {
            try {
                console.log('üîÑ Loading DABA entities...');
                const response = await fetch('/api/financial-statements/entities');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log('‚úÖ Entities loaded:', data);
                const entitySelect = document.getElementById('entitySelect');
                if (entitySelect && data.entities && Array.isArray(data.entities)) {
                    entitySelect.innerHTML = '<option value="">Select DABA Entity...</option>' +
                        data.entities.map(e => 
                            `<option value="${e.name}">${e.name} (Class ${e.licenseClass}) - ${e.status}</option>`
                        ).join('');
                    console.log(`‚úÖ Populated ${data.entities.length} entities in dropdown`);
                } else {
                    console.warn('‚ö†Ô∏è No entities found or invalid data structure:', data);
                }
            } catch (error) {
                console.error('‚ùå Error loading entities:', error);
                const entitySelect = document.getElementById('entitySelect');
                if (entitySelect) {
                    entitySelect.innerHTML = '<option value="">Error loading entities - check console</option>';
                }
            }
        }

        // Load entity financial statements
        async function loadEntityFinancials() {
            const entitySelect = document.getElementById('entitySelect');
            const entityName = entitySelect.value;
            
            if (!entityName) {
                alert('Please select an entity');
                return;
            }
            
            try {
                const response = await fetch(`/api/financial-statements/entity/${encodeURIComponent(entityName)}`);
                const data = await response.json();
                
                // Show entity info
                const entityInfoEl = document.getElementById('entityInfo');
                const entityDetailsEl = document.getElementById('entityDetails');
                if (entityInfoEl && entityDetailsEl) {
                    entityInfoEl.style.display = 'block';
                    entityDetailsEl.innerHTML = `
                        <div>
                            <div class="stat-label">Entity Name</div>
                            <div class="stat-value">${data.entity.name}</div>
                        </div>
                        <div>
                            <div class="stat-label">License Class</div>
                            <div class="stat-value">Class ${data.entity.licenseClass}</div>
                        </div>
                        <div>
                            <div class="stat-label">Status</div>
                            <div class="stat-value">${data.entity.status}</div>
                        </div>
                        <div>
                            <div class="stat-label">Jurisdiction</div>
                            <div class="stat-value">${data.entity.jurisdiction || 'N/A'}</div>
                        </div>
                    `;
                }
                
                // Display statements
                const statementsListEl = document.getElementById('financialStatementsList');
                if (statementsListEl) {
                    if (data.statements && data.statements.length > 0) {
                        statementsListEl.innerHTML = data.statements.map(stmt => {
                            const analysis = stmt.aiAnalysis;
                            if (!analysis) {
                                return `<div style="padding: 20px; background: #fef3c7; border-radius: 8px; margin-bottom: 15px;">
                                    <strong>${stmt.period} - ${stmt.statementType}</strong><br>
                                    <span style="color: #6b7280; font-size: 12px;">Analysis pending...</span>
                                </div>`;
                            }
                            const riskColor = analysis.riskAssessment === 'Critical' ? '#dc2626' :
                                            analysis.riskAssessment === 'High' ? '#f59e0b' :
                                            analysis.riskAssessment === 'Medium' ? '#fbbf24' : '#10b981';
                            const healthColor = analysis.financialHealth === 'Critical' ? '#dc2626' :
                                               analysis.financialHealth === 'Concerning' ? '#f59e0b' :
                                               analysis.financialHealth === 'Moderate' ? '#fbbf24' : '#10b981';
                            
                            return `
                                <div style="background: white; border: 2px solid ${riskColor}; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                                        <div>
                                            <h4 style="color: #1e40af; font-size: 18px; margin-bottom: 5px;">${stmt.period} - ${stmt.statementType}</h4>
                                            <div style="font-size: 12px; color: #6b7280;">Source: ${stmt.source}</div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-size: 28px; font-weight: bold; color: ${riskColor};">
                                                ${analysis.riskScore}/100
                                            </div>
                                            <div style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                                                Risk: ${analysis.riskAssessment}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div style="background: #f9fafb; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                                        <div style="font-weight: bold; color: #1e40af; margin-bottom: 10px;">AI Analysis Summary</div>
                                        <div style="font-size: 14px; color: #374151; line-height: 1.6;">
                                            ${analysis.summary}
                                        </div>
                                    </div>
                                    
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                                        <div style="background: #eff6ff; padding: 15px; border-radius: 8px;">
                                            <div class="stat-label">Compliance Status</div>
                                            <div class="stat-value" style="color: ${analysis.complianceStatus === 'Compliant' ? '#10b981' : analysis.complianceStatus === 'At Risk' ? '#f59e0b' : '#dc2626'}; font-weight: bold;">
                                                ${analysis.complianceStatus}
                                            </div>
                                        </div>
                                        <div style="background: #eff6ff; padding: 15px; border-radius: 8px;">
                                            <div class="stat-label">Financial Health</div>
                                            <div class="stat-value" style="color: ${healthColor}; font-weight: bold;">
                                                ${analysis.financialHealth}
                                            </div>
                                        </div>
                                        <div style="background: #eff6ff; padding: 15px; border-radius: 8px;">
                                            <div class="stat-label">Capital Adequacy</div>
                                            <div class="stat-value">${analysis.capitalAdequacy}</div>
                                        </div>
                                        <div style="background: #eff6ff; padding: 15px; border-radius: 8px;">
                                            <div class="stat-label">Liquidity Status</div>
                                            <div class="stat-value">${analysis.liquidityStatus}</div>
                                        </div>
                                    </div>
                                    
                                    <div style="margin-bottom: 15px;">
                                        <div style="font-weight: bold; color: #1e40af; margin-bottom: 10px;">üîç Key Findings</div>
                                        <ul style="list-style: none; padding: 0; margin: 0;">
                                            ${analysis.keyFindings.map(finding => `
                                                <li style="padding: 10px; margin-bottom: 8px; background: #f9fafb; border-left: 4px solid #3b82f6; border-radius: 4px; font-size: 13px;">
                                                    ‚Ä¢ ${finding}
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                    
                                    <div style="margin-bottom: 15px;">
                                        <div style="font-weight: bold; color: #10b981; margin-bottom: 10px;">üí° Regulatory Recommendations</div>
                                        <ul style="list-style: none; padding: 0; margin: 0;">
                                            ${analysis.recommendations.map(rec => `
                                                <li style="padding: 10px; margin-bottom: 8px; background: #f0fdf4; border-left: 4px solid #10b981; border-radius: 4px; font-size: 13px;">
                                                    ‚úì ${rec}
                                                </li>
                                            `).join('')}
                                        </ul>
                                    </div>
                                    
                                    ${analysis.regulatoryConcerns && analysis.regulatoryConcerns.length > 0 ? `
                                        <div style="background: #fee2e2; border-left: 4px solid #dc2626; padding: 15px; border-radius: 8px;">
                                            <div style="font-weight: bold; color: #dc2626; margin-bottom: 10px;">‚ö†Ô∏è Regulatory Concerns</div>
                                            <ul style="list-style: none; padding: 0; margin: 0;">
                                                ${analysis.regulatoryConcerns.map(concern => `
                                                    <li style="padding: 8px 0; color: #991b1b; font-size: 13px;">
                                                        ‚ö† ${concern}
                                                    </li>
                                                `).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('');
                    } else {
                        statementsListEl.innerHTML = `
                            <div style="text-align: center; padding: 40px; background: #f9fafb; border-radius: 8px;">
                                <p style="color: #6b7280; margin-bottom: 10px;">No financial statements found for ${entityName}</p>
                                <p style="font-size: 12px; color: #9ca3af;">Click "Generate Mock Analysis" to create a sample analysis</p>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Error loading entity financials:', error);
                alert('Error loading financial statements: ' + error.message);
            }
        }

        // Generate mock financials for testing (using real data from similar entities)
        async function generateMockFinancials() {
            const entitySelect = document.getElementById('entitySelect');
            const entityName = entitySelect.value;
            
            if (!entityName) {
                alert('Please select an entity first');
                return;
            }
            
            const period = `2024 Q${Math.floor((new Date().getMonth() + 3) / 3)}`;
            
            // Show loading state
            const statementsListEl = document.getElementById('financialStatementsList');
            if (statementsListEl) {
                statementsListEl.innerHTML = `
                    <div style="text-align: center; padding: 40px; background: #eff6ff; border-radius: 8px;">
                        <div style="font-size: 18px; color: #1e40af; margin-bottom: 15px;">üîÑ Generating Financial Analysis...</div>
                        <div style="font-size: 14px; color: #3b82f6; margin-bottom: 10px;">Fetching financial data from similar entities using AI...</div>
                        <div style="font-size: 12px; color: #6b7280;">This may take 20-30 seconds</div>
                        <div style="margin-top: 20px;">
                            <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #dbeafe; border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        </div>
                    </div>
                    <style>
                        @keyframes spin {
                            to { transform: rotate(360deg); }
                        }
                    </style>
                `;
            }
            
            try {
                console.log(`üîÑ Generating financial analysis for ${entityName}...`);
                const startTime = Date.now();
                
                const response = await fetch(`/api/financial-statements/generate-mock/${encodeURIComponent(entityName)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ period })
                });
                
                const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(1);
                
                if (response.ok) {
                    console.log(`‚úÖ Financial analysis complete in ${elapsedTime}s`);
                    await loadEntityFinancials(); // Reload to show the new statement
                } else {
                    const error = await response.json();
                    console.error('‚ùå Error:', error);
                    alert('Error generating financial analysis: ' + (error.error || 'Unknown error'));
                    if (statementsListEl) {
                        statementsListEl.innerHTML = `
                            <div style="text-align: center; padding: 40px; background: #fee2e2; border-radius: 8px;">
                                <div style="font-size: 16px; color: #dc2626; margin-bottom: 10px;">‚ùå Error</div>
                                <div style="font-size: 12px; color: #991b1b;">${error.error || 'Failed to generate analysis'}</div>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('‚ùå Error generating mock financials:', error);
                alert('Error generating financial analysis: ' + error.message);
                if (statementsListEl) {
                    statementsListEl.innerHTML = `
                        <div style="text-align: center; padding: 40px; background: #fee2e2; border-radius: 8px;">
                            <div style="font-size: 16px; color: #dc2626; margin-bottom: 10px;">‚ùå Connection Error</div>
                            <div style="font-size: 12px; color: #991b1b;">${error.message}</div>
                        </div>
                    `;
                }
            }
        }

        // Handle file upload
        let uploadedFileContent = null;
        let uploadedFileName = null;
        
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            uploadedFileName = file.name;
            const fileNameEl = document.getElementById('fileName');
            const analyzeBtn = document.getElementById('analyzeBtn');
            
            if (fileNameEl) {
                fileNameEl.textContent = `Selected: ${file.name}`;
            }
            
            try {
                // Read file content based on file type
                if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
                    // Read as text
                    uploadedFileContent = await file.text();
                    if (analyzeBtn) analyzeBtn.style.display = 'inline-block';
                } else if (file.type === 'application/pdf' || file.name.endsWith('.pdf')) {
                    // For PDF, we'll need to send to server for parsing
                    // Show message that PDF parsing will happen on server
                    if (fileNameEl) {
                        fileNameEl.textContent = `PDF selected: ${file.name} (will be parsed on server)`;
                    }
                    uploadedFileContent = file; // Keep file object for upload
                    if (analyzeBtn) analyzeBtn.style.display = 'inline-block';
                } else {
                    alert('Unsupported file type. Please upload .txt or .pdf files.');
                    return;
                }
                
                console.log(`‚úÖ File loaded: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`);
            } catch (error) {
                console.error('‚ùå Error reading file:', error);
                alert('Error reading file: ' + error.message);
            }
        }
        
        // Analyze uploaded file
        async function analyzeUploadedFile() {
            const entitySelect = document.getElementById('entitySelect');
            const entityName = entitySelect.value;
            
            if (!entityName) {
                alert('Please select an entity first');
                return;
            }
            
            if (!uploadedFileContent) {
                alert('Please upload a file first');
                return;
            }
            
            const period = `2024 Q${Math.floor((new Date().getMonth() + 3) / 3)}`;
            const statementsListEl = document.getElementById('financialStatementsList');
            
            // Show loading state
            if (statementsListEl) {
                statementsListEl.innerHTML = `
                    <div style="text-align: center; padding: 40px; background: #eff6ff; border-radius: 8px;">
                        <div style="font-size: 18px; color: #1e40af; margin-bottom: 15px;">üîÑ Analyzing Uploaded File...</div>
                        <div style="font-size: 14px; color: #3b82f6; margin-bottom: 10px;">Processing ${uploadedFileName}...</div>
                        <div style="font-size: 12px; color: #6b7280;">Using rule-based analysis (no API required)</div>
                        <div style="margin-top: 20px;">
                            <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #dbeafe; border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        </div>
                    </div>
                `;
            }
            
            try {
                let response;
                
                // If it's a File object (PDF or other binary), use upload endpoint with base64 encoding
                if (uploadedFileContent instanceof File) {
                    console.log(`üîÑ Uploading file to server for parsing and analysis: ${uploadedFileName}...`);
                    
                    // Read file as ArrayBuffer, then convert to base64
                    // Use FileReader for more reliable base64 encoding
                    const base64Content = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => {
                            // FileReader.result contains "data:application/pdf;base64,..."
                            // Extract just the base64 part
                            const base64 = reader.result.split(',')[1];
                            resolve(base64);
                        };
                        reader.onerror = (error) => reject(error);
                        reader.readAsDataURL(uploadedFileContent);
                    });
                    
                    response = await fetch('/api/financial-statements/upload', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            fileContent: base64Content,
                            fileName: uploadedFileName,
                            fileType: uploadedFileContent.type,
                            entityName: entityName,
                            period: period
                        })
                    });
                } else {
                    // For text content, use analyze endpoint
                    console.log(`üîÑ Analyzing text content for ${entityName}...`);
                    
                    response = await fetch('/api/financial-statements/analyze', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            entityName: entityName,
                            statementText: uploadedFileContent,
                            period: period,
                            source: `Uploaded: ${uploadedFileName}`,
                            statementType: 'Financial Statement'
                        })
                    });
                }
                
                if (!response.ok) {
                    // Check if response is JSON
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const error = await response.json();
                        throw new Error(error.error || 'Failed to analyze file');
                    } else {
                        const errorText = await response.text();
                        throw new Error(`Server error (${response.status}): ${errorText.substring(0, 200)}`);
                    }
                }
                
                // Verify response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    throw new Error(`Expected JSON but got ${contentType}: ${text.substring(0, 200)}`);
                }
                
                const statement = await response.json();
                console.log(`‚úÖ File analysis complete. Risk Score: ${statement.aiAnalysis?.riskScore || 'N/A'}`);
                
                // Reload entity financials to show the new statement
                await loadEntityFinancials();
                
                // Clear upload
                uploadedFileContent = null;
                uploadedFileName = null;
                const fileInput = document.getElementById('fileUpload');
                if (fileInput) fileInput.value = '';
                const fileNameEl = document.getElementById('fileName');
                if (fileNameEl) fileNameEl.textContent = '';
                const analyzeBtn = document.getElementById('analyzeBtn');
                if (analyzeBtn) analyzeBtn.style.display = 'none';
                
            } catch (error) {
                console.error('‚ùå Error analyzing uploaded file:', error);
                alert('Error analyzing file: ' + error.message);
                if (statementsListEl) {
                    statementsListEl.innerHTML = `
                        <div style="text-align: center; padding: 40px; background: #fee2e2; border-radius: 8px;">
                            <div style="font-size: 16px; color: #dc2626; margin-bottom: 10px;">‚ùå Error</div>
                            <div style="font-size: 12px; color: #991b1b;">${error.message}</div>
                        </div>
                    `;
                }
            }
        }

        // Fetch live market data
        let previousEthPrice = null;
        async function fetchMarketData() {
            try {
                const response = await fetch('/api/etherscan/market');
                const data = await response.json();
                
                if (data.ethPrice) {
                    const priceEl = document.getElementById('ethPrice');
                    const changeEl = document.getElementById('ethPriceChange');
                    if (priceEl) {
                        priceEl.textContent = '$' + data.ethPrice.toFixed(2);
                        
                        if (previousEthPrice !== null) {
                            const change = data.ethPrice - previousEthPrice;
                            const changePercent = ((change / previousEthPrice) * 100).toFixed(2);
                            
                            if (changeEl) {
                                changeEl.textContent = `${change >= 0 ? '+' : ''}${change.toFixed(2)} (${changePercent}%)`;
                                changeEl.style.color = change >= 0 ? '#10b981' : '#ef4444';
                            }
                        }
                        previousEthPrice = data.ethPrice;
                    }
                }
                
                if (data.blockNumber) {
                    const blockEl = document.getElementById('currentBlock');
                    if (blockEl) {
                        blockEl.textContent = parseInt(data.blockNumber).toLocaleString();
                    }
                }
                
                if (data.gasPrices) {
                    const safeEl = document.getElementById('gasSafe');
                    const proposedEl = document.getElementById('gasProposed');
                    const fastEl = document.getElementById('gasFast');
                    const baseFeeEl = document.getElementById('gasBaseFee');
                    
                    if (safeEl) safeEl.textContent = data.gasPrices.safe;
                    if (proposedEl) proposedEl.textContent = data.gasPrices.proposed;
                    if (fastEl) fastEl.textContent = data.gasPrices.fast;
                    if (baseFeeEl) baseFeeEl.textContent = data.gasPrices.baseFee || 'N/A';
                }
                
                const lastUpdatedEl = document.getElementById('marketLastUpdated');
                if (lastUpdatedEl) {
                    lastUpdatedEl.textContent = new Date().toLocaleTimeString();
                }
            } catch (error) {
                console.error('Error fetching market data:', error);
            }
        }

        // Search Ethereum address
        async function searchEthereumAddress() {
            const input = document.getElementById('addressSearchInput');
            const address = input.value.trim();
            
            if (!address || address.length < 10 || !address.startsWith('0x')) {
                alert('Please enter a valid Ethereum address');
                return;
            }
            
            // Show loading state
            document.getElementById('addressEmptyState').style.display = 'none';
            document.getElementById('addressAnalysisResults').style.display = 'none';
            document.getElementById('addressLoadingState').style.display = 'block';
            
            try {
                const response = await fetch(`/api/etherscan/address/${address}`);
                const data = await response.json();
                
                // Hide loading, show results
                document.getElementById('addressLoadingState').style.display = 'none';
                document.getElementById('addressAnalysisResults').style.display = 'block';
                
                // Update summary
                document.getElementById('analyzedAddress').textContent = data.address;
                document.getElementById('addressBalance').textContent = parseFloat(data.balance).toFixed(4) + ' ETH';
                document.getElementById('addressTxCount').textContent = data.transactions.length;
                document.getElementById('addressTokenCount').textContent = data.tokenTransfers.length;
                
                // Update risk analysis
                if (data.analysis) {
                    const riskScore = Math.round(data.analysis.riskScore || 0);
                    const riskScoreEl = document.getElementById('addressRiskScore');
                    const riskStatusEl = document.getElementById('addressRiskStatus');
                    
                    if (riskScoreEl) riskScoreEl.textContent = riskScore;
                    
                    if (riskStatusEl) {
                        if (riskScore >= 70) {
                            riskStatusEl.className = 'status-badge status-critical';
                            riskStatusEl.textContent = 'HIGH RISK';
                        } else if (riskScore >= 40) {
                            riskStatusEl.className = 'status-badge status-at-risk';
                            riskStatusEl.textContent = 'MODERATE RISK';
                        } else {
                            riskStatusEl.className = 'status-badge status-healthy';
                            riskStatusEl.textContent = 'LOW RISK';
                        }
                    }
                    
                    const totalVolume = BigInt(data.analysis.totalVolume || '0');
                    const avgTxSize = BigInt(data.analysis.averageTransactionSize || '0');
                    
                    document.getElementById('addressTotalVolume').textContent = formatWei(totalVolume);
                    document.getElementById('addressAvgTxSize').textContent = formatWei(avgTxSize);
                    document.getElementById('addressRapidTx').textContent = data.analysis.rapidTransactions || 0;
                    
                    // Update flags
                    const flagsEl = document.getElementById('addressSuspiciousFlags');
                    if (flagsEl) {
                        if (data.analysis.flags && data.analysis.flags.length > 0) {
                            flagsEl.innerHTML = data.analysis.flags.map(flag => `
                                <span style="padding: 6px 12px; background: #fee2e2; border-radius: 4px; font-size: 12px; color: #dc2626; font-weight: bold;">
                                    ${flag}
                                </span>
                            `).join('');
                        } else {
                            flagsEl.innerHTML = '<span style="padding: 6px 12px; background: #d1fae5; border-radius: 4px; font-size: 12px; color: #065f46;">No suspicious flags detected</span>';
                        }
                    }
                }
                
                // Update transactions list
                const txListEl = document.getElementById('addressTransactionsList');
                if (txListEl && data.transactions) {
                    if (data.transactions.length === 0) {
                        txListEl.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">No transactions found</p>';
                    } else {
                        txListEl.innerHTML = data.transactions.slice(0, 50).map(tx => {
                            const value = BigInt(tx.value || '0');
                            const ethValue = Number(value) / 1e18;
                            const date = new Date(parseInt(tx.timeStamp) * 1000);
                            const isError = tx.isError === '1';
                            
                            return `
                                <div style="padding: 15px; margin-bottom: 10px; background: ${isError ? '#fee2e2' : '#f9fafb'}; border-radius: 8px; border-left: 4px solid ${isError ? '#ef4444' : '#3b82f6'};">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                        <div style="flex: 1;">
                                            <div style="font-weight: bold; color: #1e40af; margin-bottom: 5px; font-family: monospace; font-size: 12px;">
                                                ${tx.hash.slice(0, 20)}...${tx.hash.slice(-10)}
                                            </div>
                                            <div style="font-size: 11px; color: #6b7280;">
                                                ${date.toLocaleString()}
                                            </div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-weight: bold; color: #111827; font-size: 14px;">
                                                ${ethValue.toFixed(6)} ETH
                                            </div>
                                            ${isError ? '<div style="font-size: 11px; color: #ef4444; margin-top: 2px;">‚ö†Ô∏è Failed</div>' : ''}
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 15px; font-size: 11px; color: #6b7280;">
                                        <div>
                                            <span style="font-weight: bold;">From:</span>
                                            <a href="https://etherscan.io/address/${tx.from}" target="_blank" style="color: #3b82f6; font-family: monospace; margin-left: 5px;">
                                                ${tx.from.slice(0, 10)}...${tx.from.slice(-8)}
                                            </a>
                                        </div>
                                        <div>
                                            <span style="font-weight: bold;">To:</span>
                                            <a href="https://etherscan.io/address/${tx.to || tx.contractAddress || 'N/A'}" target="_blank" style="color: #3b82f6; font-family: monospace; margin-left: 5px;">
                                                ${tx.to ? (tx.to.slice(0, 10) + '...' + tx.to.slice(-8)) : (tx.contractAddress ? 'Contract: ' + tx.contractAddress.slice(0, 10) + '...' : 'N/A')}
                                            </a>
                                        </div>
                                        <div>
                                            <a href="https://etherscan.io/tx/${tx.hash}" target="_blank" style="color: #3b82f6; text-decoration: none;">
                                                View on Etherscan ‚Üí
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                }
            } catch (error) {
                console.error('Error searching address:', error);
                document.getElementById('addressLoadingState').style.display = 'none';
                document.getElementById('addressEmptyState').style.display = 'block';
                alert('Error fetching address data: ' + error.message);
            }
        }

        // Quick select address from watchlist
        function quickSelectAddress(address) {
            document.getElementById('addressSearchInput').value = address;
            searchEthereumAddress();
        }

        // Toggle category lists
        function toggleCategory(category) {
            const listEl = document.getElementById(category + 'List');
            const toggleEl = document.getElementById(category + 'Toggle');
            
            if (listEl && toggleEl) {
                if (listEl.style.display === 'none' || !listEl.style.display) {
                    listEl.style.display = 'block';
                    toggleEl.textContent = '‚ñ≤';
                } else {
                    listEl.style.display = 'none';
                    toggleEl.textContent = '‚ñº';
                }
            }
        }

        // Allow Enter key to search
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('addressSearchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        searchEthereumAddress();
                    }
                });
            }
        });

        // Auto-refresh every 3 seconds for better responsiveness
        fetchRegulatoryData();
        const refreshInterval = setInterval(() => {
            fetchRegulatoryData();
        }, 3000);
        
        // Auto-refresh market data every 30 seconds
        fetchMarketData();
        const marketRefreshInterval = setInterval(() => {
            if (document.getElementById('tab-content-crypto-market')?.classList.contains('active')) {
                fetchMarketData();
            }
        }, 30000);
        
        // Load crypto news on page load and auto-refresh every 5 minutes
        loadCryptoNews();
        const newsRefreshInterval = setInterval(() => {
            loadCryptoNews();
        }, 300000); // 5 minutes = 300000ms
        
        // Load financial entities on page load
        loadFinancialEntities();
        
        // Keep interval reference for potential cleanup
        window.dashboardRefreshInterval = refreshInterval;
        
        // Allow Enter key to search wallet
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('walletSearchInput');
            if (searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        searchWallet();
                    }
                });
            }
        });
    </script>
</body>
</html>


